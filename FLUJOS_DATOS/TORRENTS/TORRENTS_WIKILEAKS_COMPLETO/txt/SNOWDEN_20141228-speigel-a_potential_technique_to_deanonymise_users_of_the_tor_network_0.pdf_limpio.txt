uk top secret strap1 comint reference opcmtechb61 date 13 june 2011 copy potential technique to deanonymise users of the tor network opcmcr gchq summary new technique to deanonymise users of the tor network is demonstrated it is shown that the majority of small truthed set of data can be dcanonymiscd without any false hits anywhere in eight bearerhours of data for this algorithm to be further tested we must run some tor exit nodes and collect data from these sigint packet logging of guard node traffic is also required demonstration software is available in the form of an r package from opcmtechb61 18 pages this information is exempt under the freedom of information act 2000 foia and may be exempt under other uk legislation refer any foia queries to gchq uk top secret strap1 comint uk top secret strap1 comint opcmtechb61 this page is intentionally left blank this information is exempt under the freedom of information act 2000 foia and may be exempt under other uk refer any foia queries to gchq on uk top secret strap1 comint uk top secret strap1 comint opcmtechb61 potential technique to deanonymise users of the tor network opcmcr gchq 13 june 2011 1 introduction the onion router tor 1 is used by individuals and organisations that want to hide the originating ip address of their communications tor client chooses the circuit their traffic will follow through set of tor routers before contacting the destination server the first hop after the client is to the subset of the routers designated as guard nodes the final hop in the tor network is from subset of routers which choose to be an exit11 node there can be any number of tor routers between the guard and exit nodes but typical clients choose to have one router there are many features that mean it is hard to track traffic through the tor network traffic is encrypted in multiple layers between the client node and each tor router leading to the onion analogy hence data between each tor router has different ciphertexts unencrypted traffic is only seen between the exit node and destination server tor splits all traffic up into standard size cells therefore packet sizes can not be used to follow traffic each connection between tor routers will typically multiplex many circuits traffic effectively masking any particular users traffic to ensure fairness of service tor has percircuit ratelimiting storeandforward buffer in each router this buffer tends to flatten timing features in traffic 3 the aim of this work is to find the client ip address associated with unencrypted traffic between an exit node and destination server this paper achieves this aim given the following constraints we must own the exit node this constraint means that we can demultiplex traffic by tor circuit and thus get cleaner signal see section 5 for more detail 3 this information is exempt under the freedom of information act 2qqq foia and may be exempt under other uk refer any foia queries to gchq uk top secret strap1 comint uk top secret strap1 comint opcmtechb61 wc must be able to log the packet times of the traffic from the guard node to the client the tor communication must be long and structured wc will demonstrate the technique against single user browsing the web via tor the client must not be running tor router of their own otherwise we can not separate the clients own traffic from other tor traffic the attack we will present is based on correlating exit node and guard node traffic and does not require tracking communications through any intermediate link in the tor network this approach should help maximise the chance of successful attack despite incomplete sigint coverage 2 test data wc arc going to work with two sets of data 1 truthed data where we have matched guard node and exit node traffic for single user web browsing 2 bulk traffic logs for guard nodes from four sigint bearers wc will try to develop techniques that can correctly match up the truth data but not false alarm anywhere in the bulk sigint logs 21 truthed data tor is designed to make it hard to link client and exit node traffic together in conjunc tion with ictrne and jtrig we came up with way to collect the exit node traffic from our own web browsing as illustrated in figure 1 we used virtual private server vps as an intermediate destination for our traffic we then run packet loggers on our client machine and the vps we run an open http proxy server on the vps wc want to run an open proxy server to ensure that there is minimal impact on the data flows which for example authenti cation may introduce whilst still being able to conduct representative web browsing risk of an open proxy server is that other internet users may use it thus potentially lead ing to unlawful traffic interception to avoid this danger we changed our useragent11 string to nonstandard value and the proxy server was configured to only respond to this user agent furthermore the proxy server was only active for the brief duration of the experiment this setup was approved by jtrig traffic due to other users was detected in the packet logs 4 this information is exempt under the freedom of information act 2000 foia and may be exempt under other uk refer any foia queries to gchq uk top secret strap1 comint uk top secret strap1 comint opcmtechb61 figure 1 our test data collection infrastructure we control the two shaded hosts and run packet logging on these hosts we connect to the public tor network guard node g and exit node arc shown using default settings of the tor button we then browse public web sites on our client we used the standard tor button webbrowser extension to access tor with two minor modifications firstly we changed the internal tor button proxy polipo to use our open http proxy after transiting tor secondly we changed the webbrowser useragent to match that accepted by our open http proxy four experiments of about ten minutes each were conducted 1 news search on bing for news followed by browsing bbc news and then the washington post 2 tor browsing the tor website and then using privacy checking website 3 download visit to slashdot followed by downloading large pdf file 4 forum search on google followed by browsing pc technical help forum packet logs were collected for each of these in each experiment one guard node and one exit node was used apart from in experiment 2 where tor set up new path during the experiment with change in both guard node and exit node therefore we will generally split experiment 2 into the two circuits 2a and 2b 22 bulk data to prove low false alarm rate of any algorithm we need bulk data we used ip address dumps from four internet bearers two were clientserver bearers and two were serverclient bearers the data was kindly collected by gte with their highspeed 5 this information is exempt under the freedom of information act 2000 foia and may be exempt under other uk legislation refer any foia queries to gchq on uk top secret strap1 comint uk top secret strap1 comint opcmtechb61 data recorder the timestamps arc microsecond accurate but the data comes with packet size protocol or port information each capture was two hours long totalling eight hours of collection we identify tor traffic by use of consensus logs 4 which are imported by ictr ne the tor network decides what nodes arc part of the network and what their roles arc we filter the sigint packet traces to packets that satisfy one ip address being guard node as identified in the consensus log closest to the data collection period and the other ip address not being seen any the consensus log from month surround ing that period this approach will inaccurately identify traffic between clients and guard nodes the inaccuracy comes from the fact that the guard nodes may be doing other nontor communication we therefore believe that we will approximately filter down to superset of the wanted traffic we note that these filtering rules mean that we will ignore any clients that also run tor node however this constraint will still apply for potential operational scenario where we also run guard nodes without full knowledge of the client one can not tell whether circuit is terminating in the client or being relayed through its tor node 3 why we are not tracking circuit through the tor network when we started this work we considered attacks that tried to follow data through the tor network however an initial experiment based on jtrig browsing logs showed that sigint visibility was too low for significant chance of success we will now describe the experiment conducted but the rest of the section is not required reading we compare two sources of data communication between tor servers seen in sigint tdsd deployed an ictr signature in squeal to detect communication between tor nodes across the sigint fleet for two days in december 2010 to remove signature false hits wc filter down to hits where both ip addresses arc known to be tor routers by consensus logs 4 from the same period tor links used by jtrig for similar period jtrig log the usage of tor connections each of their circuits typically have two links between tor routers 6 this information is exempt under the freedom of information acootwoijnchttawjixe refer any foia queries to gchq uk top secret strap1 comint uk top secret strap1 comint opcmtechb61 there were 1958 tor routers in the relevant consensus files of which 1893 had signature hits we consider links between tor routers as undirected and an all pairs calculations allows us to estimate that there arc 179 to 192 million possible links in the tor network we do not know whether we do not see router due to it being off or invisible to us however we only see 6185 links between tor routers in the sigint logs therefore we are seeing about 03 of possible tor links in sigint note this percentage is likely to be an small underestimate of the visibility of tor links as most tor circuits will consist of two links within the tor network one link involving guard node and one link involving an exit node based on the consensus logs there are 165 million links that satisfy this constraint this link count raises visibility to 04 the jtrig logs use 8294 links between tor nodes of which we see 13 therefore we could only see 016 of jtrig used tor links in sigint the jtrig link visibility percentage and the population link visibility percentage suggest significantly different underlying distribution pvalue between 0005 and 001 tor is claimed to use servers geolocation to choose circuits perhaps this circuit choosing algorithm hinders our visibility if we assume the visibility of each link in 2path within the tor network is inde pendent then the chance of seeing any particular 2path is between 1 in 100000 and 1 in 400000 in the jtrig logs of 2935 paths we would expect to observe both links of one or more paths with probability 07 to 3 we saw one so either we were lucky or link visibility is correlated in path to complete circuit trace you would also need to see the clienttoguardnode traffic and the exitnodetoserver traffic which would lower the probability of visibility yet further we believe such probabilities are too low for useful attack and thus we do not consider circuit tracing attacks further 4 correlating guard and exit node traffic we will use the correlation in the timing of data packets between guard and exit nodes to deanonymise tor there arc two features that we need to remember about tor tor repacketiscs the data which means that packets and packet sizes can not be cxactly followed through the network each tor node has ratelimiting storeandforward methodology which will af fect packet timings these two factors means that burst of packets entering the tor network will be smeared out over time into cells that do not directly map to the input packets and comparing histograms of guard and exit traffic is hard 3 7 this information is exempt under the freedom of information acootlanchtiajixemp refer any foia queries to gchq on uk top secret strap1 comint uk top secret strap1 comint opcmtechb61 our main insight is to consider cumulative distributions rather than histograms in particular we will consider cumulative packet count and cumulative tcp payload bytes we hope that over long time window that there will be approximate conservation of these quantities and the impact of rate limiting will be less significant rate limiting will just impose maximum gradient in figure 2 and figure 3 we show cumulative packet counts and cumulative tcp payload sizes for our truth data it can be seen that lot of features arc preserved it seems sensible to consider that comparison of these cumulative plots between guard and exit node traffic could lead to deanonymisation technique considering figure 2 in more detail one can see steps in these plots replicated between guard node and exit node traffic for all the plots apart from perhaps ictos 4 perhaps clienttoserver traffic is harder to deanonymisc you can also see that there arc changes in scale for example in experiment 3 there are more guard node packets than exit node packets figure 3 of cumulative tcp payloads shows some similar features all the scrvcr toclicnt graphs show preserved steps however the clienttoserver graphs do not show very clear relationships in particular looking at ictos 3 you can see big difference during the download of the large pdf file the exit node is sending tcp acks with payload back to the server but the client is sending larger tor acknowledgement cells back which leads to large difference in graph shape therefore we will consider deanonymisation based on cumulative packet counts as well as looking like generally cleaner picture than using tcp payload such an approach requires less data to be collected by the sigint system this easier data collection is exemplified by our bulk data logs these logs do not contain packet sizes let alone tcp payload sizes 5 why we want to own the exit node sigint gives us two added complications that the above truth data analysis above has ignored 1 each exit node is serving many clients which will add unwanted data into the traf fic for single user tor users arc encouraged to run privacypreserving proxies eg privoxy or polipo and these proxies try to normalise the traffic so that ev eryone shares the same http header format the impact of this is that sigint proxy demultiplexing techniques can not reliably be used it is potentially possible to try and demultiplex traffic via content analysis eg looking at what links arc included in webpages but such technique would be complex and fragile to html formatting errors and require all web browsing to be nonencrypted this information is exempt under the freedom of information acootwoijnchttawjixem refer any foia queries to gchq on uk top secret strap1 comint uk top secret strap1 comint opcmtechb61 cumulative packet count exit guard u 4j cu u ìd q u u ctos ctos 1602 1604 1606 1 1602 1 1604 1 1606 ctos ctos ctos stoc stoc stoc stoc stoc i 1622 1624 i 1626 1628 time i 1624 i 1626 i 1628 1546 1548 1550 1552 1554 1556 i i i i i i 1546 1548 1550 1552 1554 1556 m 1622 hhmm i 1602 1604 1612 1614 i 1606 1616 i 1608 i 1618 _ n 1602 i 1604 1612 1614 1606 i 1616 i 1608 1618 figure 2 cumulative packet count for the four truthed sessions on the lefthand side the clienttoserver traffic is shown on the righthand side the servertoclient traffic is shown the second truthed session is split into the two significant circuits used this information is exempt under the freedom of information acootljncnttawjixem refer any foia queries to gchq onh uk top secret strap1 comint uk top secret strap1 comint opcmtechb61 cumulative payload exit guard m m ctos stoc 1 i i i i i i i i i i i 1546 1548 1550 1552 1554 1556 1546 1548 1550 1552 1554 1556 ii d jd t3 iü îd q q u h stoc 2a 4j u 1 1602 1604 1 1606 1 1608 3 ctos 3 1 1602 1 1604 1606 1 1602 1 1604 1 1606 ctos 2b stoc 2b lfl cu m t 1602 t 1604 1606 t 1608 u stoc t t 1612 1614 1616 1618 stoc 1622 1624 1626 1628 1622 1 1624 1 1626 1 1628 time hhmm figure 3 cumulative payload bytes for the four truthed sessions on the lefthand side the clienttoserver traffic is shown on the righthand side the scrvertoclient traffic is shown the second truthed session is split into the two significant circuits used 10 this information is exempt under the freedom of information information legislation refer any foia queries to gchq onl uk top secret strap1 comint uk top secret strap1 comint opcmtechb61 2 limited sigint coverage will mean we will only see subset of the exit node traffic the exit node could be contacting servers anywhere on the internet and unless we have collection very close to the exit node we arc likely to only see subset of these connections potential approach around these problems is to demultiplex by http server we hope that in time window there might only be one user browsing particular website so demultiplexing by server will therefore demultiplex by user too we also hope for complete collection of some of these streams as packets will hopefully follow small number of routes between the exit node and the http server we show the influence of demultiplexing by http server in figure 4 it can be seen that the clear picture in the previous section is longer present modern webpage is typically made up of content from many different http servers by eye it can be seen that it is hard to link many of these fragments of traffic per http server to the guard node traffic indeed using the mathematical technique we will describe in the following section only four of the servertoclient http traces could be successfully linked to guard node traffic we therefore recommend that we analyse traffic from exit nodes that we control such an approach has several desirable features we can demultiplex exit node traffic by client as the tor exit node can associate all traffic with circuit complex and potentially inaccurate demultiplexing algorithms arc not required we collect all exit node traffic for each client circuit as opposed to sigint which may only give fragments of the traffic we therefore have the cleanest possible data we hope to dcanonymisc all traffic for circuit rather than just fragments of the traffic which may not contain the data of interest to an analyst resultant database of tor traffic would give simple place to experiment and deploy tor deanonymisation analytics the nsa have already demonstrated the demultiplexing of traffic in tor exit node 2 6 score we compare an exit trace and guard node trace using basic linear regression building on suggestion of we bin time up into 1 second bins i 1 t 11 this information is exempt under the freedom of information act 2000 foia and may be exempt under other uk legislation refer any foia queries to gchq on uk top secret strap1 comint uk top secret strap1 comint opcmtechb61 cumulative guard guard secondary exit fsdncom exitanalyzeprivacynet exitatsgstaticcom exitattachtsgstaticcom exitctsgstaticcom exitforumstechguyorg count per host exitmedia3washingtonpostcom exitmediawashingtonpostcom exit news bbci mgco ilk exitwwwbingcom exitwwwgovernmentatticorg exitwwwonionrouternet exitwwwtorprojectorg exitwwwwashingtonpostcom 1546 1548 1550 1552 1554 1556 1546 1548 1550 1552 1554 1556 ctos stoc ctos 2 stoc 2 àj l1 c m u 4j 11 u 13 q_ d 4j to m j zi u rsi 1602 1604 1606 1608 1612 1614 1616 1618 i 1602 1604 i 1606 1612 1614 1616 1618 r 1608 ctos stoc 1624 i 1626 1628 time i 1624 i 1626 i 1628 1 1622 1622 hhmm figure 4 cumulative packct count for the four truthed sessions but with exit traffic split across the main hosts contacted on the lefthand side the clicnttoserver traffic is shown on the righthand side the scrvertoclient traffic is shown 12 this information is exempt under the freedom of information act 2000 foia and may be exempt under other uk information legislation refer any foia queries to gchq on uk top secret strap1 comint uk top secret strap1 comint opcmtechb61 this choice is slightly arbitrary but does match the timing precision reported by most sigint systems in each bin we then have pair etgi where is the cumulative exit node packet count at time i and gt is the cumulative guard node packet count at time i our primary measure of association is the correlation between et and 7 as measured by the pearson productmoment correlation coefficient r we expect that when the two traffic streams are associated that very high correlation coefficient will result we note that high correlation coefficients arc generally expected as were comparing two increasing sequences to remove false positives we also fit the following basic linear model gi i wc then use 3 to discard bad matches we expect that similar number of packets are expected in both traces we only consider traces where 12 3 2 key consideration is how to handle guard node and exit node traces that do not precisely overlap wc are assuming that our exit node trace is the complete log of tor circuit on the other hand the guard node trace may contain traffic for other tor circuits we therefore truncate the guard node trace to the period of the exit node trace wc also pad the guard node packet counts with zero if required to span the exit node trace in addition we consider score all possible time shifts of the guard node trace against the exit node trace ie trying out different timing offsets we do this as we do not know the clock offset in our truth data set and to be as generous as possible in finding false positives in the bulk logs it is not known whether such sliding approach may prove useful in practice with known clock offsets it is possible that such an approach may also combat unknown delays in the tor network 7 results we first show results of the proposed technique on our truth data set and then consider false positive rates as mentioned above we will slide the putative guard node and exit nodes traces against each other to allow for an unknown clock offset between the client and http proxy in the truth data set and to give us the maximum number of comparisons when trying to assess the false positive rate 71 true positives in the truth data the first experiments arc to understand the behaviour of the algorithm on the truth data in figure 5 we show plots of r2 and 13 as the time offset is varied it can be seen 13 this information is exempt under the freedom of information information legislation refer any foia queries to gchq on uk top secret strap1 comint uk top secret strap1 comint opcmtechb61 beta 20 15 10 05 oo 20 15 10 05 00 20 15 10 05 00 500 500 500 time offset s 500 ctos 1 stoc 1 ctos 2a stoc 2a 1 ìi n 1 1 il ctos 2b stoc 2b x ctos 3 stoc 3 z7 ctos 4 stoc 4 20 15 10 05 00 20 15 10 05 00 figure 5 the correlation r2 and the linear regression coefficient 3 as the time offset between the guard node and exit node traffic is varied 14 this information is exempt under the freedom of information act 2000 foia and may be exempt under other uk information legislation refer any foia queries to gchq on uk top secret strap1 comint uk top secret strap1 comint opcmtechb61 sample clicnttoscrvcr servertoclicnt 1 09977 09991 2a 09238 09464 2b 09957 09983 3 09952 09998 4 09975 09983 tabic 1 the maximum values of r2 achieved on the truth data server to client server to client oo 02 04 06 08 10 ie06 ie04 ie02 ieoo false positive rate false positive rate figure 6 the roc curve for the scrvertoclicnt direction falsepositive rate shown on linear axis in the left plot and on logarithmic axis in the right plot that correlations close to 1 arc achieved at time offsets close to 0 the short circuit i2a fails to achieve high correlation sensible values for 3 also result in particular in the servertoclicnt direction the maximum value of the correlation is also shown in table 1 and it can be seen that higher correlations arc achieved in the servertoclicnt direction 72 false positives in the bulk data we now compare our truth exit traces to the bulk data set and sec if we find any false positives as previously mentioned were sliding time to allow as many traces as possible to be included in the servertoclicnt direction wc can choose threshold of 0998 such that we only miss one true positive whilst having false positives the one circuit we miss is 2a11 where the session is short the main activity is only over 33 seconds the roc curve looks very good figure 6 15 this information is exempt under the freedom of information act 2000 foia and may be exempt under other uk information legislation refer any foia queries to gchq on uk top secret strap1 comint uk top secret strap1comint opcmtechb61 client to server client to server 1 1 00 02 04 06 10 1e06 false positive rate false positive rate figure 7 the roc curve for the clicnttoserver direction falsepositive rate shown on linear axis in the left plot and on logarithmic axis in the right plot in the clicnttoserver direction the true and false cases are not so well separated see figure 7 we arc not able to detect any true positives without some false hits this poor separation is probably due to there being less distinctive structure in the clicnttoserver direction http requests share similar size in the scrvertoclient direction threshold of 0998 finds the true cases except 2a11 without any false hits we can try to extrapolate what this false hit rate means to sigint collection it is likely that one would restrict the time slide we would imagine maximum of 5 seconds may be sensible as opposed to the 2 hours in each bearer we have allowed if we imagine rcstacking our 5 circuits x 4 bearers x 120 minutes of collection into 288 circuits x 100 bearers x 10 seconds you could imagine it is possible we could run 288 test circuits against an aperture of 100 bearers without false hitting when allowing ourselves to slide the time window by 5 seconds with our current test data we cant promise lower false positive rate and further experimentation with sustained collection would be required to better evaluate false positive rate 8 software we provide reference implementation of the algorithm as an r package flowcomparc three functions arc provided formatflowdata formats data to that used internally in the algorithm 16 uk top secret strap1 comint this information is exempt under the freedom of information act 2000 ffoiaandmavbeexemrt information legislation refer any foia queries to gchq on h uk top secret strap1 comint opcmtechb61 scoreflowpair scores pair of flows at all time offsets or at limited range of time offsets fmdbestmatchingflow find the guard flow that best matches an exit flow we also include our truth data as data frame callcd tortruth this package is available from 9 conclusion we have shown technique that can deanonymisc tor webbrowsing given packet times between the client and guard node and packet times from the exit node filtered to single circuit the false positive rate looks low enough to suggest this technique should be carried forward the required data is not collected at present for this technique to work the following additional data feeds will be required secondaccurate packet logging at tor exit nodes we control with packets labelled by unique circuit identifier secondaccurate packet logging of sessions between tor clients and tor guard nodes this data could be obtained by sigint or by running guard nodes the sigint solution would require an uptodate feed of tor consensus documents tor ip addresses could then be extracted from the consensus documents for filtering by the sigint system at the time of writing jtrig are investigating the collection of the exit node data and ictrfsp arc trialling feed of guard node data from research bearers wider testing is recommended to better characterise the false positive rate first test case both because we have truth data and for infosec purposes may be to try and deanonymisc jtrig tor usage references 1 various tor resources linked off 2 nsa tor capability reported by 3 options for further research into the tor network b7694ba50013104 2 february 2010 discover 6722909 17 this information is exempt under the freedom of information act 2000 foia and may be exempt under other uk information legislation refer any foia queries to gchq on uk top secret strap1 comint uk top secret strap1 comint opcmtechb61 this page is intentionally left blank 18 this information is exempt under the freedom of information act 2000 foia and may be exempt under other uk information legislation refer any foia queries to gchq on uk top secret strap1 comint