top secretcomintrel to usa aus can gbr nzl20291123 turmoil ipsec vpn sessioniz at ion issue nol issue date 081508 responsible authority author technical poc product approver derived from nsacssm 152 dated 20041123 declassify on 20291123 top secretcomintrel to usa aus can gbr nzl20291123 top secretcomintrel to usa aus can gbr nzl20291123 derived from nsacssm 152 dated 20041123 declassify on 20291123 table of contents revision history 4 reference documents 4 10 u scope 5 20 s esp sessionizatiqn 5 21 s ipesp 5 211 s detection 5 212 s sessionizing 6 213 s the stack 6 22 s ipahesp 7 221 s detection 7 222 s sessionizing 7 223 s the stack 8 30 s ike sessionizatiqn 9 31 u ipudpisakmp 9 311 s detection 9 312 s sessionizing 9 313 fs the stack 10 32 u ipudpnui i sisakmp 10 321 s detection 10 322 s sessionizing 11 323 u the stack 12 33 u iptcpisakmp 12 331 s detection 12 332 s sessionizing 13 333 s the stack 14 34 u iptcpnullsisakmp 14 341 s detection 14 342 s sessionizing 15 343 s the stack 16 40 u summary 17 page 2 of 18 top secretcomintrel to usa aus can gbr nzl20291123 top secretcomintrel to usa aus can gbr nzl20291123 page 3 of 18 top secretcomintrel to usa aus can gbr nzl20291123 top secretcomintrel to usa aus can gbr nzl20291123 revision history issue date author amendments 01 81508 et first draft of document reference documents page 4 of 18 top secretcomintrel to usa aus can gbr nzl20291123 top secretcomintrel to usa aus can gbr nzl20291123 10 u scope this document describes the sessionization requirements for the various ipsec vpn protocols processed in turmoil the list of ipsec protocol stacks of interest is shown here ipesp ipahesp ipudpisakmp ipu dpnullsl sakm p iptcpi sakmp iptcpnullsi sakmp currently ipesp ipudp and iptcp are successfully sessionized by the fip other ipsec stacks have been observed in the field and we have requirements to process them in turmoil for completeness all of the stacks are discussed in this document even thouqh some are currently being processed 20 s esp sessionization 21 s ipesp 211 s detection the aeg loads the fspf with the following keyword and mask pair for this protocol keyword 45 ff ff ff ff ff ff ff ff 32 ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff f5 mask ff 00 00 00 00 00 00 00 00 ff 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 0f this indicates that the packets that satisfy the following parameters will be selected by this keyword for processing in the esp_aeg ipv4 packet ip header length 5 ip next protocol esp 0x32 esp sequence number 5 the esp sequence number requirement implements sampling function on the esp reducing the esp traffic by factor of 116 to limit the esp loading in the aeg page 5 of 18 top secretcomintrel to usa aus can gbr nzl20291123 top secretcomintrel to usa aus can gbr nzl20291123 212 s sessionizing the esp packets would be sessionized by the following set of parameters ip next protocol 50 0x32 ip source address ip destination address esp spi 213 s the stack the fields utilized in sessionization are highlighted in red in the diagram below l l 5 6 i i type i versioni header of service i length tos total length bytes identif time to live ttl integr cation 13 bit i i flag i 0 d i f fi fragment offset next protocol header checksum source ip address destination ip address options if any security parameters index sequence number payload data variable padding 0255 bytes pad length next header i i i conf cov jered i i ip aint cov i ered i i i i esp i i i i i i v ty check valuelcv variable page 6 of 18 top secretcomintrel to usa aus can gbr nzl20291123 top secretcomintrel to usa aus can gbr nzl20291123 22 s ipahesp 221 s detection the aeg loads the fspf with the following keyword and mask pair for this protocol keyword 45 ff ff ff ff ff ff ff ff 33 ff ff ff ff ff ff ff ff ff ff 32 ff ff ff ff ff ff ff ff ff ff f5 mask ff 00 00 00 00 00 00 00 00 ff 00 00 00 00 00 00 00 00 00 00 ff 00 00 00 00 00 00 00 00 00 00 0f this indicates that the packets that satisfy the following parameters will be selected by this keyword for processing in the esp_aeg ipv4 packet ip header length 5 ip next protocol ah 0x33 ah next payload esp 0x32 esp sequence number 5 222 s sessionizing the ahesp packets would be sessionized by the following set of parameters ip next protocol 51 0x33 ip source address ip destination address ah next payload 50 0x32 ah spi esp spi the software fspf is currently programmed to recognize only tcp udp and esp as valid network layers however since our ahesmevwors start at the network ip layer those packets will make it through the fspf to the aeg that the change to the fspf to recognize ah at the transport layer would be easy to implement the dfce does not currently recognize ah as valid transport layer and that change will apparently be difficult to implement the new idea is to develop applicationspecific demux components for the that will perform any desired sessionization based on parameters after the network ip layer page 7 of 18 top secretcomintrel to usa aus can gbr nzl20291123 top secretcomintrel to usa aus can gbr nzl20291123 223 s the stack l l 5 6 i i type versioni header of service i length tos ident time to live ttl next header cation next protocol total length bytes 3 bit i flag i 0 d m f f fragment offset header checksum source ip address destination ip address options if any payload len reserved security parameters index sequence number integrity check valueicv variable security parameters index sequence number payload data variable integr padding 0255 bytes pad length next header aint cov ered i i i i jconf cov ered i i ty check valueicv variable page 8 of 18 top secretcomintrel to usa aus can gbr nzl20291123 top secretcomintrel to usa aus can gbr nzl20291123 30 s ike sessionization 31 u ipudpisakmp 311 s detection the aeg loads the fspf with the following keyword and mask pair for this protocol keyword 45 ff ff ff ff ff ff ff ff 11 ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff 00 10 00 00 ff ff ff ff 00 00 mask ff 00 00 00 00 00 00 00 00 ff 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 60 ff d8 f8 00 00 00 00 ff ff this indicates that the packets that satisfy the following parameters will be selected by this keyword for processing in the ike_aeg ipv4 packet ip header length 5 ip next protocol udp 0x11 isakmp version 0x10 isakmp next payload exchange type and flags fields all have ranges of valid values isakmp length header payload 64k we have similar keywordmask pair for isakmp version 99 312 s sessionizing the udpisakmp packets would be sessionized by the following set of parameters ip next protocol udp 0x11 ip source address ip destination address udp source port udp destination port page 9 of 18 top secretcomintrel to usa aus can gbr nzl20291123 top secretcomintrel to usa aus can gbr nzl20291123 313 s the stack 11 3 0 5 6 1 type total length bytes verslonj headerj of service length tos identification 3 bit fragment offset i flag 0 d m i f f time next header checksum to live ttl protocol source ip address destination ip address options if any source port destination port message length checksum initiator cookie responder cookie next payload mjver mnver exchange type flags message id length ip udp v i i isakmp i i i i v 32 u ipudpnullsisakmp 321 s detection the aeg loads the fspf with the following keyword and mask pair for this protocol keyword 45 ff ff ff ff ff ff ff ff 11 ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff 00 00 00 00 ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff 00 10 00 00 ff ff ff ff 00 00 mask ff 00 00 00 00 00 00 00 00 ff 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ff ff ff ff 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 60 ff d8 f8 00 00 00 00 ff ff this indicates that the packets that satisfy the following parameters will be selected by this keyword for processing in the ike_aeg page 10 of 18 top secretcomintrel to usa aus can gbr nzl20291123 top secretcomintrel to usa aus can gbr nzl20291123 ipv4 packet ip header length 5 ip next protocol udp 0x11 4 bytes of nulls between the udp and isakmp layers isakmp version 0x10 isakmp next payload exchange type and flags fields all have ranges of valid values isakmp length header payload 64k we have similar keywordmask pair for isakmp version 99 322 s sessionizing the udpnullsisakmp packets would be sessionized by the following set of parameters ip next protocol udp 0x11 ip source address ip destination address udp source port udp destination port page 11 of 18 top secretcomintrel to usa aus can gbr nzl20291123 top secretcomintrel to usa aus can gbr nzl20291123 323 ip v udp v i i i isakmp i i i i v 33 u iptcpisakmp 331 s detection the aeg loads the fspf with the following keyword and mask pair for this protocol keyword 45 ff ff ff ff ff ff ff ff 06 ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff 00 10 00 00 ff ff ff 00 00 mask ff 00 00 00 00 00 00 00 00 ff 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 60 ff d8 f8 00 00 00 ff ff u the stack 11 3 0 5 6 1 1 type 1 total length bytes version header of service 1 length tos 1 identif cation 3 bit 1 fragment offset 1 flag 1 0 d m 1 1 f f time next 1 header checksum to live ttl protocol 1 source ip address destination ip address options if any sourc port 1 destination port message length 1 checksum nulls initiator cookie responder cookie next payload mjver 1 mnver exchange type flags message id length page 12 of 18 top secretcomintrel to usa aus can gbr nzl20291123 top secretcomintrel to usa aus can gbr nzl20291123 this indicates that the packets that satisfy the following parameters will be selected by this keyword for processing in the ike_aeg ipv4 packet ip header length 5 ip next protocol tcp 0x06 isakmp version 0x10 isakmp next payload exchange type and flags fields all have ranges of valid values isakmp length header payload 64k we have similar keywordmask pair for isakmp version 99 332 s sessionizing the tcpisakmp packets would be sessionized by the following set of parameters ip next protocol tcp 0x06 ip source address ip destination address tcp source port tcp destination port page 13 of 18 top secretcomintrel to usa aus can gbr nzl20291123 top secretcomintrel to usa aus can gbr nzl20291123 333 ip v i i i i tcp i i i i i v i i i isakmp i i v 34 u iptcpnullsisakmp 341 s detection the aeg loads the fspf with the following keyword and mask pair for this protocol s the stack 11 3 0 5 6 1 1 1 type total length bytes version header 1 of service 1 length tos 1 identification 3 bit 1 fragment offset 1 flag 0 d m 1 1 f fl time next 1 header checksum to live ttl i protocol source ip address destination ip address options if any source port destination port sequence number acknowledgement number data 1 reserved u p rs fl window offset 1 rcssyi 1 gkhtnn checksum 1 urgent pointer options if any 1 padding initiator cookie responder cookie next payload mjver 1 mnver exchange type 1 flags message id length page 14 of 18 top secretcomintrel to usa aus can gbr nzl20291123 top secretcomintrel to usa aus can gbr nzl20291123 keyword 45 ff ff ff ff ff ff ff ff 06 ff ff ff ff ff ff ff ff ff ff ff ff ff ff 00 00 00 00 ff 10 00 00 ff ff ff ff 00 00 mask ff 00 00 00 00 00 00 00 00 ff 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ff ff ff ff 00 ff d8 f8 00 00 00 00 ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 60 this indicates that the packets that satisfy the following parameters will be selected by this keyword for processing in the ike_aeg ipv4 packet ip header length 5 ip next protocol tcp 0x06 4 bytes of nulls between the tcp and i sakmp layers i sakmp version 0x10 i sakmp next payload exchange type and flags fields all have ranges of valid values i sakmp length header payload 64k we have similar keywordmask pair for isakmp version 99 342 s sessionizing the tcpnullsisakmp packets would be sessionized by the following set of parameters ip next protocol tcp 0x06 ip source address ip destination address tcp source port tcp destination port page 15 of 18 top secretcomintrel to usa aus can gbr nzl20291123 top secretcomintrel to usa aus can gbr nzl20291123 343 s the stack type total length bytes versionj headerj of service length tos 1 identification 3 bit fragment offset i flag 10 d m ip i f f i i time next header checksum to live ttl protocol j j 1 source ip address j destination ip address j options if any v j source port destination port j sequence number j acknowledgement number 1 tcp data reserved u p r s f window offset j r c s s y111 i gkhtnn i i i checksum urgent pointer 1 options if any padding v nulls initiator cookie responder cookie isakmp next payload mjver mnver exchange type flags message id length v page 16 of 18 top secretcomintrel to usa aus can gbr nzl20291123 top secretcomintrel to usa aus can gbr nzl20291123 40 u summary the fip currently recognizes udp tcp and esp as valid network layer protocols and currently sessionizes those packet types the new requirement for ipahesp will require changes to the fip to recognize ah as valid layer and will also require changes to the dfce to allow those packets through there has been talk of having applicationspecific demuxes developed and inserted into the to perform any required sessionization beyond the transport layer for example the esp demux would be responsible for sessionizing on spi value the table below summarizes the various protocol stacks the parts of the stacks that are used in ppf keyword detection and how the associated packets should be sessionized protocol stack keyword detection layers sessionization requirements ipesp ip esp ip next protocol 50 ip source address ip destination address esp spi ipahesp ip ah esp ip next protocol 51 ip source address ip destination address ah next header 50 ah spi esp spi ipudpi sakmp we have separate keywords for isakmp versions 10 and 99 ip udp isakmp ip next protocol 17 ip source address ip destination address udp source port udp destination port ipudpnullsl sakmp we have separate keywords for isakmp versions 10 and 99 ip udp isakmp ip next protocol 17 ip source address ip destination address udp source port udp destination port page 17 of 18 top secretcomintrel to usa aus can gbr nzl20291123 top secretcomintrel to usa aus can gbr nzl20291123 iptcpi sakmp we have separate keywords for isakmp versions 10 and 99 ip tcp isakmp ip next protocol 6 ip source address ip destination address tcp source port tcp destination port iptcpnullsl sakmp we have separate keywords for isakmp versions 10 and 99 ip tcp isakmp ip next protocol 6 ip source address ip destination address tcp source port tcp destination port page 18 of 18 top secretcomintrel to usa aus can gbr nzl20291123