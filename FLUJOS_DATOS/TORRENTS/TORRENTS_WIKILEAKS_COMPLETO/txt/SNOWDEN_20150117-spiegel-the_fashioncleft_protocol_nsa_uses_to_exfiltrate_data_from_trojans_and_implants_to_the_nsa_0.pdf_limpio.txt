the fashioncleft protocol stdp s32354 go tinyurlqp5atn october 16 2008 top secretcomintrelto usafvey 1 top secretcomintrelto usafvey definition fashioncleft taodntprotocol used by implants to exfiltrate collected network packets to the common data receptor cdr provides support for metadata authenticationintegrity antireplay encryption data encryption uses 1024bit rsa 128bit rc6 based on dnt standards fogynull exfil protocol funnelaps exfil data format shellgrey exfil metadata format october 16 2008 top secretcomintrelto usafvey 2 top secretcomintrelto usafvey how to exfiltrate ip packets make copy of the captured packet modify packet ip destination address modify other protocol fields ip udp tcp as needed to bypass firewalls and tag packets for id send modified data packet dp to new destination october 16 2008 top secretcomintrelto usafvey 3 top secretcomintrelto usafvey receiver needs metadata metadata explains how to 1 identify an exfil packet and the implant source 2 recover original ip destination address 3 recover other original protocol fields ip udp tcp 4 contains key to decrvptunmunge transport layer payload metadata sent in session announcement sa sas use ipudp or iptcp sent to an ipport multiple copies of sa sent to mitigate dropped sa packets receiver is dynamically configured with sa ipports infrastructure implant private keys october 16 2008 top secretcomintrelto usafvey 4 top secretcomintrelto usafvey session announcement format ip header tcp or udp header sa payload infrastructure header 128 bytes rsa encrypted w infrastructure public key contains shalinfhdr id id deploymentid targetid implantid implant header 128 bytes rsa encrypted w ids public key contains shalimphdr 128bit cv and crc16 checksum foi exfilmetadata block exfilmetadata block variable rc6 encrypted wcv minimum packet length 344 bytes october 16 2008 top secretcomintrelto usafvey 5 top secretcomintrelto usafvey session announcement processing 1 look for sas at ipport that are at least 344 bytes long ppfapikeywordcriterionipdstaddr ipdstport easyquick initial check 1 rsa decrypt infhdr w infrastructure private key authenticate w sha1 slow secondary check cant withstand much nonsa traffic on ipport 1 rsa decrypt imphdr w ids private key authenticate w sha1 1 rc6 decrypt exfilmetadata w cv and perform crc16 integrity check 1 extract metadata and create data packet dp filter rule metadata contains either 5tuples or patternmaskoffset that match dps ppfapikeywordcriterion5tuple or patternmaskoffset october 16 2008 top secretcomintrelto usafvey 6 top secretcomintrelto usafvey data packet processing 1 identify an exfil packet that matches dp filter rule 2 modify to original ip destination address 3 modify to original protocol fields ip udp tcp 4 decrvptunmunge transport layer payload have now recovered the original captured packet 1 associate metadata with recovered packet implant casn turmoil link casn 1 perform protocol specific processing reinject bundle need option to force packets to be strongly selected october 16 2008 top secretcomintrelto usafvey 7 questions october 16 2008 top secretcomintrelto usafvey 8 supplemental material october 16 2008 top secretcomintrelto usafvey 9 top secretcomintrelto usafvey fashioncleft turmoil adding fashioncleft capability to turmoil supports these missions vpn provide ikei sakmp key exchanges obtained from unique tao accesses to the vpn attack orchestrator voip create new high bandwidth exfiltration path to turmoil for streaming voip to overcome limited cdr bandwidth others automatic exfil path discovery etc october 16 2008 top secretcomintrelto usafvey 10 top secretcomintrelto usafvey library reuse cdr ppf tao common data receptor access control point acp c surpasspin innerouter spin spout java libftsk fogynull technique software kit c turmoil packet processing framework c atomic event generator aeg stateful event generator seg event filter ef packettopacket transform engine october 16 2008 top secretcomintrelto usafvey 11 top secretcomintrelto usafvey acp equivalent api cachesettimewindow cachesetsize cache cache cache cache cache getlnfo clear enablearchiving disablearchiving getarchivingstatus safilter set safilterdelete safiltergetlist safilterclearlist dpfilter set create dpfilter check cache for match dpfilterdelete dpfiltergetlist dpfilterclearlist acp getstatus cachegetarchivingstatus safiltergetlist dpfiltergetlist cachegetlnfo acpcheckrawpacket packet processing callback cache the packet if cachefull archivelfenabled warnlfincachetimewindow findprocess all matching dpfilters findprocess unique matching safilter october 16 2008 top secretcomintrelto usafvey 12 top secretcomintrelto usafvey to be determined tasking monitoring of turmoil adddeletequery tasking jms itx adddeletequery other processingconfig options mbean taskingconfiguration persistence processing metrics logging should tasking use cdr icf files implant config files should turmoil interface w puzzlecube tao tasking database protocol processing metadata implant casn turmoil link casn reinject packet bundling voip vpn etc force strong selection option onoff turmoil 30sec dfce vs cdr 15minute packet cache october 16 2008 top secretcomintrelto usafvey 13 top secretcomintrelto usafvey current cdr tasking flashhandle mission manager fmm provides tasking to cdrsurpasspin fmm server reads configuration information from the puzzlecube database allows the operator to addchange tasking including generating implant encryption keys tasking changes are sent back to puzzlecube via jdbc messages published via jms messages to surpasspin surpasspin stores the tasking in persistent pojo cache october 16 2008 top secretcomintrelto usafvey 14 top secretcomintrelto usafvey implant configuration file icf 4843 hammerchant icf_name 4843alb2o00o0000011321mar2007 icf dtg wed mar 21 181233 2007 icf info 4843 hammerchant for target id 0xalb20000 implant_id 0x4843 implantver 1 target id oxalb2o00o deployment id 0x00000113 target_cn hammerchant_batonrouge target ip 172326113 target_host batonrouge implant lpl9 tunnelidipaddressports tunnelid 2fashioncleft implant_lp1 2681117812000 implant_lp2 2681117812001 implant_rc6_cv1 e3d3ae0a b341adel 4dce30eo 77861acc implant rsa inf rsaname infrastructure_key_ersa rsainf0 wed aug 25 101729 2004 rsagenkey v20 rsasize 1024 rsamod 32 0xe420b8d5 0x47673b7a 0xaf4c39al 0xc704d5ba _7 lines deleted rsamu 33 0xed5692bl 0x449323bb 0xed7653e5 0xcd9feb5e 7 lines deleted 0x00000002 rsapriv 32 0x63c5f12b 0xdlb85426 0x4f5a681c 0x68be4748 7 lines deleted rsapub 32 0x00000003 0x00000000 0x00000000 0x00000000 7 lines deleted imp lant_rsa_imp rsaname 4843_hammerchant_at_hammerchant_alb2000000000113 same format as implant_rsa_inf october 16 2008 top secretcomintrelto usafvey 15 top secretcomintrelto usafvey packet cache options cdr uses 15 minute packet cache sas are sent multiple times per session and the cache is searched for matching dps to mitigate dropped sas simple cache use existing turmoil cache delay flow control engine large cache create large cache that allows 15 minute delay options start with simple cache and see if we miss too many dps if problems then implement large cache start with large cache and see if we can keep up with data rate memory requirements if problems then scale back to simple cache october 16 2008 top secretcomintrelto usafvey 16 top secretcomintrelto usafvey simple packet cache the hardware lightdelay provides 30 second cache the software xfspf provides 2 second cache pros 1 problems with buffering data since turmoil does it automatically 2 work required to implement cache cons 1 cache is much smaller than 15 minute 900 seconds 30x 30 cdr requirement 2 cache delay is further reduced by unspecified latency to register new dp filters after receipt of sa 3 many dps would be ignored if sa is misseddelayed possibly mitigated by sending multiple sa copies in first 30 or 2 seconds of exfil october 16 2008 top secretcomintrelto usafvey 17 top secretcomintrelto usafvey large packet cache implement large 15minute packet cache within aeg pros 1 meets cdr cache requirement 2 mostall dps should be processed even if initial sa is misseddelayed cons 1 violates normal turmoil architecture may not be possiblefeasible to implement large cache at typical turmoil rates 2 requires caching all ip packets sent to cdr ip address then manually searching for dp hits instead of letting the ppf search packets 3 timeeffort required to implement october 16 2008 top secretcomintrelto usafvey 18 top secretcomintrelto usafvey sadp id processing october 16 2008 top secretcomintrelto usafvey 19