classification top secretcomintx1 comint xi fashioncleft interface control document updated 15 june 2009 document number taodnt_se07_005_v11 28 march 2005 fashioncleft_protocoldoc last saved 4172013 090800 pm last printed 6152009 021500 pm drv fm nsacssm 1232 dated 24 feb 98 decl on xi classification top secret comint xi table of contents 1 fu introduction 1 2 ufquq fashioncleft protocol details 6 3 ufouo packet selection algorithms 20 appendix glossary 1 classification top secret comint xi drv fm nsacssm 1232 dated 24 feb 98 declon xi last saved 4172013 090800 pm last printed 6152009 021500 pm fashioncleft_protocoldoc page 2 of 26 classification top secretcomintx1 comint xi ufouo fashioncleft icd 1 u introduction 11 u document description ssi this document defines the fashioncleft computer network exploitation cne collection protocol that enables raw data packets from the external internet to interface to the common data receptor cdr of data network technologys dnts common system architecture csa this interface will be deployed to support tailored access operations tao onnet operations specifically implants that are required to exfiltrate collected network packets but due to implant processing and bandwidth constraints are required to utilize low overhead egress protocol ssi this document defines the interface requirement that the common data receptor and implant must support to enable successful reception of raw data packets sent by the implant it includes conceptual data flow diagrams and network diagrams to define the system it also contains detailed data format examples data field definitions and description of the protocol 12 ufouo reference documents 1 flaxen precept external sourcetocdr interface control document front end eicd nsadnt doc taodnt_se07_001_v10 16 june 2003 2 flaxenprecept external data flow cdrtonsa corporate interface control document back end eicd nsadnt doc taodnt_se07_002_v001 3 shellgrey binary metadata tag standard 13 u background ssi the common data receptor cdr is dntdesigned system to perform the data reception portion of what is commonly termed listening post the cdr supports common interface that dnt developers use for data formatting and reception in addition the common data receptor concept emphasizes the use of data receptor operations manager and network manager vice listening post ssix1 the introduction of the fashioncleft protocol is necessary because without the fashioncleft protocol the implanttocdr communication previously did not handle raw ip data packets in addition an implant previously had way to deal with the challenge of processing streaming data while minimizing the computing overhead associated with encapsulating and encrypting the data this new protocol provides the developer mechanism to specify the level of encryption implemented in the implant as precursor to data transmission ssix1 the fashioncleft protocol supports the passing of metadata securely and with authentication ssix1 the metadata is used to support the reconstruction of ip packets and when applicable to convey information about the session ___ roc last saved 4172013 090800 pm fashioncleft_protocoldoc page 1 of 26 m2qqq 0215w pm classification top secret comint xi ssix1 the cdr architecture includes the outer surpasspin inner surpasspin and seagullfaro subsystems in addition oneway transfer device rootknot composed of pitcher catcher and their oneway link supplants the air gap previously employed that required manual transfer by diskette in order to support this configuration dnt has been working closely with the remote operations center roc to design and build figbuild an external mission network and opticpinch an internal mission network ssi figure 131 below shows the common data receptor architecture as described in the referenced flaxenprecept eicds ssi the interfaces supported by the cdr must also support the cdrs separation of classified and unclassified processing classified information such as egress data and metadata must be protected while on the unclassified network side before passing through the oneway link this interface also supports the cdr protection of classified information figure 131 common data receptor architecture common data receptor opticpinch collection s pinwale collection logs office of target pursuit fcrensics lab manual processing and swveeporuvard hog oh streaming packets 14 ufouo interface description ssi this interface provides tao developers low overheard solution to exfiltrate streaming data typically associated with implants that collect raw packets from the target environment while providing the appropriate metadata and authentication the basic design principle behind this low overhead approach is to redirect copy or clone of the original packet to another host or listening post in this case the cdr inorder to redirect packet features of the copy of the packet must be altered particularly the source and destination addresses and possibly the port numbers classification top secret comint xi fashioncleft_protocoldoc page 2 of 26 drv fm nsacssm 1232 dated 24 feb 98 declon xi last saved 4172013 090800 pm last printed 6152009 021500 pm classification top secret comint xi ssi this interface is designed to support the reception of cloned packets and their associated metadata originating from implants while supporting authentication of the egress data and correlation of received packets to the appropriate metadata to provide greater flexibility for the implant several configurable levels of encryption are supported ssi the following assumptions are made this interface supports egress of data and does not support command and control channel this interface is used by implants which for valid reasons are unable to implement egress methods that require greater resources from the target such as encapsulation egress data must be associated with encrypted authenticated metadata this interface may not be suitable for all boundary defenses that could be encountered within target environment extensibility has been designed to allow additional packet selection algorithms to be added such that future changes to skirt other defenses can be readily included ssi this interface implements four functions transmission of session announcements transmission of metadata transmission of data packets reconstruction of data packets using the metadata and reconstruction of sessions using metadata to track and collate data packets belonging to particular session ssi during session establishment an implant authenticates itself to the cdr and requests the cdr to begin reception of data packets that belong to this session as part of establishing the session metadata about the session is passed along with metadata that the cdr requires to assign data packets to the session and collate data packets within the session the session establishment function uses the fogynull protocol family to authenticate and securely pass metadata packet collation information and data packet encryption status ssi there are several methods that an implant could use to collate data packets to the appropriate session but only one method can be used in any session the implant picks the appropriate exfil type either packet or session and either exfiltrates one modified copy of source packet per source packet or assembles the source data payloads from several source packets into one packet to be exfiltrated the fashioncleft interface design allows these methods to be extensible so additional methods can later be developed and included to meet operational constraints imposed by boundary defenses ssi the data packets are generally copy of packet that was collected and had its destination address changed to send it to the cdr additional fields might have been altered to support one of the methods of assigning data packets to session and collating data within session if selected during the session establishment the payload section of the packet may be encrypted using the mode specified by the fashioncleft protocol encryption mode selection in the fogynull implant header classification top secret comint xi drv fm nsacssm 1232 dated 24 feb 98 declon xi cclj1in _ 7 rc last saved 4172013 090800 pm fashioncleft_protocoldoc page 3 of 26 pmtej 3ssm 021500 pm classification top secret comint xi ssi figure 141 below shows how the fashioncleft protocol modifies the conceptual diagram of the common data receptor architecture as described in the referenced flaxenprecept eicds fashioncleft changes to the protocols previously defined for this architecture are shown in italics in figure 141 and in subsequent tables listing fashioncleft changes classification top secret comint xi drv fm nsacssm 1232 dated 24 feb 98 declon xi relir last saved 4172013 090800 pm fashioncleft_protocoldoc page 4 of 26 pmtej 3ssm 021500 pm classification top secret comint xi figure 141 common data receptor with fashioncleft fashioncleft changes to standards and cdr components highlevel fogvnull funnelaps bcfiltration data shellgrey meta data tfl c n 3j u ff j in jj if u s ro ss example h Ã¬ is 5 s 5 di co di s tb q s ii i infh pr targetid x implan t1d imp hd r p 0x09 fa shi on cleft adds fields to id m etadata for sirs am ing packets fashioncleft adds oa od to id m etadata for stream ing packets exfilhdr md len l1 datalen 0 and ne w encryption option ids fashioncleft does mot append sfreaw ing data to these packets metadata exfil id e1 exfil_typ p fashioncleft adds fio fulty characterize data it any newtags the sou roe raw repeat at least 3 times per session fashioncleft only uses if bansm ission is ifia tcp sines m 1 ack opto na i ip hp r subprotocoi header pavload data encrypted per mphdr fashioncleft payload packetof raw site am ing data classification top secret comint xi drv fm nsacssm 1232 dated 24 feb 98 declon xi relir last saved 4172013 090800 pm fashioncleft_protocoldoc page 5 of 26 pmtej 3ssm 021500 pm classification top secret comint xi 2 ufouo fashioncleft protocol details ssi metadata is used to announce the initiation of session to describe the session and to provide original packet reconstruction information ssi from the point of view of an implant streaming data transmission session is accomplished in two steps first sending the session announcement metadata followed by the continuous sending of the streaming data packets 21 ufouo fashioncleft session announcement ssi fashioncleft session announcement metadata announces the initiation of session describes the session and conveys data packet reconstruction and association information to enable data packets and sessions to be reconstructed after collection 211 ufouo session announcement description ssi fashioncleft adds two new fields in the fogynull protocol infrastructure header to proclaim that data packets containing streaming data are to be sent using the fashioncleft protocol packetifselector packet1fdata and adds new opcode tag 0x09 plus new encryption mode tags in the fogynull protocol implant header to indicate that raw packets will be exfiltrated and the extent to which they are being encrypted ssi fashioncleft also adds new tags in the shellgrey protocol that fully characterize the original source and original destination of streaming data packets that follow in addition fashioncleft uses the shellgrey exfil_type metadata tag to indicate whether the target data will be exfiltrated as packet data one exfil data packet per cloned target packet or session data each exfil data packet contains target data payload that may have been captured prior to being encapsulated by the target source into multiple packets for transmission example session announcement imf hdr deploymentid 0x00 tatgetlcl 0xala2a3a4 implantid 0xblb2 packetifselector 0x01 packetif data imp hdr opcode 0x09 instlcl 0x00 implantver oxdl ertcryptmode 0x02 exf1lblk metadatalen ml datalen 0 metadatablk extillcl oxooooooez extiltype packet timeotlntercept oxffoo filterid 0x12 classification top secret comint xi fashioncleft_protocoldoc page 6 of 26 drv fm nsacssm 1232 dated 24 feb 98 declon xi last saved 4172013 090800 pm last printed 6152009 021500 pm classification top secret comint xi ssi the structure of session announcement is comprised of the fogynull headers both the infrastructure and implants headers followed by shellgrey metadata format within funnelaps protocol with data all multibyte fields in the infrastructure and implant headers are in network byte order ie big endian 212 ufouo fogynull headers 2121 ufouo infrastructure header ssi the purpose of the following three elements of the infrastructure header version 2 and later of fogynull is to indicate the characteristics of the origination of the packet implant id target id deployment id allow different encryption keys for same implantid targetid ssi the purpose of the next two elements of the infrastructure header fas hi on cleft addition to fogynull is as follows table 21211 format of infrastructure header block 0 31 0 sha1 hash data bytes 019 of bytes 20127 20 random 28 infrastructure header version 0x02 implant id 32 lengfri 36 target id 40 timestamp sec 44 sequence 48 deployment id 52 packet lf selector see table 311 54 56 packet lf data 32 bytes 86 86 random 124 random special constraints rsa ssi in the fogynull protocol additional elements follow to complete the 128 bytes of the infrastructure header packet lf selector this field directly supports fashioncleft exfiltration packet lf data this new field uses the first 32 bytes of formerly random field tssi the purpose of the new packet lf selector oxon field is to allow selection of choice of algorithm that will collate the data to the sessions the following three choices are provided data packets follow 0x00 classification top secret comint xi drv fm nsacssm 1232 dated 24 feb 98 declon xi cclj1in _ 7 rc last saved 4172013 090800 pm fashioncleft_protocoldoc page 7 of 26 pmtej 3ssm 021500 pm classification top secret comint xi generic pattern matching selector fixed ip4 field matching selector csi the details of these selections are further discussed in section 3 because the choice values are extensible it could be possible to add additional choices in the future csi contents of the packet lf data field depend on the choice previously selected in the packet lf selector field 2122 csi implant header tssi the implant header total of 128 bytes is composed of five parts opcode 0x09 new value indicating raw packet exfil instanceid implant generated see shellgrey exfilid below implantversion as defined by fogynull encryptmode new values for fogynull encryption mode table 21221 ssi generic implant header block 0 31 0 sha1 hash data bytes 019 of bytes 20127 20 random 28 implant header version 0x02 implant operation 32 instance id 36 implant version encryption mode 0x0001 see table 21222 page 9 40 data length 0x00 44 random 52 rc6 session key 68 random 76 rc6 message indicator ml 92 random 124 random special constraints rsa classification top secret comint xi fashioncleft_protocoldoc page 8 of 26 drv fm nsacssm 1232 dated 24 feb 98 declon xi last saved 4172013 090800 pm last printed 6152009 021500 pm classification top secret comint xi ssi new encryption modes and options for encryption of data packets are added to the fogynull authentication protocol as shown in table 21222 the new values are italicized and their cells are highlighted table 21222 ssi new encryption modes value session exfil packet proposed packet implemented 0x01 rc6session rc6composite na default 0x02 rc6session rc6composite none na 0x03 rc6session rc6composite munge na 0x04 rc6session rc6composite rc6composit na ssi fashioncleft allows new exfiltype packet it was originally proposed that three new encryption modes would be used for packet exfil using the values 0x02 through 0x04 however this proposed version was not actually implemented applying encryption is just what it implies the term munge implies that privacy scrambling will be applied to the data to make it little less tractable to anyone trying to detect third party presence in the target system the rc6composite mode uses full 128bit encryption as described in section 232 ssi as implemented fashioncleft packet exfil should always use encryption mode 0x01 default the actual encryption mode used for packet exfil is then specified within the metadata block using shellgrey tags as described in section 232 213 ufouo payload content information blocks csi the payload funnelaps cne protocol data characterizing the contents of the data packets is composed of two blocks 16byte exfil header and variable length metadata block that conforms to the shellgrey cne data protocol there is exfil data block in this payload and the contained data length is therefore reflected with zero length indicator in the exfil header classification top secret comint xi drv fm nsacssm 1232 dated 24 feb 98 declon xi relir last saved 4172013 090800 pm fashioncleft_protocoldoc page 9 of 26 pmtej 3ssm 021500 pm classification top secret comint xi 2131 csi content of the exfil header ssi the exfil header is 16byte block that contains the following fields table 21311 ssi exfil header byte 0 12 3 0 4 8 12 version the version of this header checksum two byte crc16 checksum of the encoded metadata block metadata length four byte unsigned integer in network byte order that represents the number of bytes in the encoded metadata block including any padding data length four byte unsigned integer in networkbyte order that represents the number of bytes that comprises the exfil data block the data length value used for fashioncleft must be 0 since there is exfil data within the session announcement authentication copy of bytes 4851 of the implant header match validates the successful decryption of the exfil header 2132 ufouo content of the metadata block tssi the metadata block encoded according to the shellgrey metadata protocol described in references 1 and 12 contains the collectionrelated information and packet reconstruction information the required collectionrelated items are exfilid must be unique for implantid targetid deploymentid instanceld exfiltype packet or session timeoflntercept filterid tssi the reconstructionrelated metadata was originally contained in the following seven tags that show the original source and routing of the packets that were exfiltrated these tags are now provided only for informational purposes and are not used to reconstruct the original packet exfilsubtype optional fieldoxolindicates the data type is voiptype identifiers can be extended as necessary ip4sourceaddr ip4destinationaddr ip4sourceport classification top secret comint xi fashioncleft_protocoldoc page 10 of 26 version 0x0001 checksum metadata length data length 0x00000000 authentication drv fm nsacssm 1232 dated 24 feb 98 declon xi last saved 4172013 090800 pm last printed 6152009 021500 pm classification top secret comint xi ip4 destination port ip4ttl ipsubprotocol as defined by the ip protocol tssi reconstruction is now explicitly specified using shellgrey reconstruction tags such as see reference 12 for complete list packet_bit_replace packet_bit_replace_ip4 packet_byte_remove packet_b yte_remove_l p4 packet_byte_replace packet_byte_replace_ip4 packet_ip_addr tssi shellgrey reconstruction and decryption tags section 232 are processed in the order in which they occur the reconstruction result is therefore highly dependent on the specific reconstruction tags used and the order in which they occur this flexibility allows the sender the implant to specify how to transform the exfiltrated data and the receiver simply follows instructions without needing any knowledge of customproprietary data formats 22 ufouo encryptiondecryptionvalidation tssi all communication will be encrypted with the appropriate level of encryption for the information transmission medium and target system rsa public keys are used to encrypt session announcement infrastructure and implant headers decryption is performed using rsa private keys rc6 block ciphers are used to encrypt the session announcement exfil header and metadata block and optionally data packets using the rc6 session key and message indicators contained within the session announcement implant header tssi the flashhandle mission management fmm system is the database resource for generatingretaining crypto keys and other information eg implantlds targetlds all session announcements must have two 128byte rsaencrypted header blocks the infrastructure and implant header blocks are encrypted using the rsa128 algorithm metadata blocks and optionally data packets are encrypted using the rc616 algorithm in output feedback mode ofb see the key management diagram below classification top secret comint xi drv fm nsacssm 1232 dated 24 feb 98 declon xi relir last saved 4172013 090800 pm fashioncleft_protocoldoc page 11 of 26 pmtej 3ssm 021500 pm classification top secret comint xi top secretcomint2 0291123 r cne technique low side acp 1 deployed keys infrastructure key rsa pub implant key rsa pub exfil key modifier rc6 i exfil key rc6 session keyrc6 Ã­ session generated random generator keys r surpasspin etcher outer deployed keys infrastructure key rsa pvt implant key rsa pvt rootknot catcher session key rc6 session generated keys r high side surpasspin inner deployed keys 1 exfil keymodifier rcs i exfil key rc6 session keyrc6 session generated keys figure 221 u key management tssi each cne technique will contain the following deployed keys infrastructure header key rsa public implant header key rsa public shared key rc6 called exfil key modifier rc6 in diagram above as shown above the infrastructure and implant private keys are retainedprotected within flaxenprecept and are never deployed to the implant tssi the first rsa public key the infrastructure key is global key that is common to many cne techniquestargets and provides access to flaxenprecept it is used to encrypt the infrastructure header the infrastructure private key is used to decrypt the infrastructure header and sha1 hash of bytes 20127 is computed and compared against bytes 019 to validate successful decryption tssi the second rsa public key the implant key is unique key for the cne technique to use on specific target and will be used to support command and exfiltration functions it is used to encrypt the implant header the implant private key is used to decrypt the implant header and sha1 hash of bytes 20127 is computed and compared against bytes 0 19 to validate successful decryption the implant header contains cne techniquespecific information ie implant operation session key 16bytes and message indicator ml for each session new session key rc6 and ml are generated randomly by the implant classification top secret comint xi drv fm nsacssm 1232 dated 24 feb 98 declon xi relir last saved 4172013 090800 pm fashioncleft_protocoldoc page 12 of 26 pmtej 3ssm 021500 pm classification top secret comint xi tssi the exfil header is encrypteddecrypted using the session key rc6 and ml from the implant header success is verified by comparing decrypted exfil header bytes 1215 with decrypted implant header bytes 4851 tssi composite exfil key rc6 is computed by combining the session key rc6 with the shared key rc6 first populate 32byte array with the 16byte shared key followed by the 16byte session key next perform sha1 hash of this byte array the first 16 bytes of the resultant sha1 hash is the composite exfil key rc6 tssi the metadata block contains shellgrey tags and is encrypteddecrypted using the composite exfil key rc6 and mll where 1 represents adding one represented as bigendian 4byte word to the last four bytes of the ml from the implant header bytes 8891 the crc16 of the decrypted metadata block is computed and compared against decrypted exfil header bytes 23 to validate successful decryption tssi the data packets are optionally rc6 encrypted or munged as specified by shellgrey tags as described in section 232 23 ufouo data packets 231 ufouo data packet description ssi data packets are ip packets which may or may not be copy of an intercepted ip packet these packets have valid ip header to allow the packet to be routed to the lp address other bytes within this packet may be altered to allow the packet to pass the targets egress filters andor satisfy specific packet selection criterion the shellgrey tags contained within the metadata block specify reconstruction and decryption commands that are processed in the order in which they occur to transform the received data packet into the desired data format for further processing the reconstruction result is therefore highly dependent on the specific reconstruction tags used and the order in which they occur for example as shown below the received data packet always contains an ip header but the shellgrey tag packet_ip4_remove can be used to remove the ip4 header subsequent shellgrey commands could then operate on either the remaining packet buffer layer or on the transport layer if it exists table 2311 u packet layers packet data ip header mandatory ip data optional transport header optional transport data optional 232 ufouo data packet encryption csi packets will be encrypted munged or unencrypted the encryption mode and the portion of the packet that is encryptedmunged are indicated in the metadata block using shellgrey tags there are three possible encryption values for exfil type packet none munge and rc6composite none should be used only when less processing power is available than required to munge the data munge should be used only when less processing power is available than required to perform full rc6composite mode encryption classification top secret comint xi drv fm nsacssm 1232 dated 24 feb 98 declon xi cclj1in _ 7 rc last saved 4172013 090800 pm fashioncleft_protocoldoc page 13 of 26 pmtej 3ssm 021500 pm classification top secret comint xi 2321 ufouo encryption none csi encryption type none is implied if none of the encryption related shellgrey tags described below are present within the metadata block 2322 ufouo encryption munge csi munge is defined as or 4 byte pattern xored with the data when 1 byte pattern is used the data is also xored with the positional index modulo 255 the munge pattern and the portion of the packet layer that is munged are passed during the session announcement in the metadata block as one of the tags listed below this pattern must be consistent throughout the session and should not be changed in mid session the shellgrey tags are table 23221 ssi munge shellgrey tags name tag values packet layer exfil_munge_byte deprecated do not use 3c 1byte unsigned mungebyte operation exfil_munge_word deprecated do not use 80 14 2byte unsigned mungebytes2 operation for all tags below apply demunge to specified layer starting at offset for length bytes length oxff end of packet packet _demunge8 86 08 3byte unsigned mungebyte offsetbyte lengthbyte outioffset inioffset xor mungebyte xor i mod 255 packet data packet _demunge8jp4 86 09 3byte unsigned mungebyte offsetbyte lengthbyte outioffset inioffset xor mungebyte xor i mod 255 ip data packet _demunge8_ip4_transport 86 11 3byte unsigned mungebyte offsetbyte lengthbyte outioffset inioffset xor mungebyte xor i mod 255 transport data packet _demunge32 86 oa 6byte unsigned mungebytes4 offsetbyte lengthbyte outioffset inioffset xor mungebytesi mod 4 packet data packet _demunge32_ip4 86 ob 6byte unsigned mungebytes4 offsetbyte lengthbyte outioffset inioffset xor mungebytesi mod 4 ip data packet _demunge32_ip4_transport 86 12 6byte unsigned mungebytes4 offsetbyte lengthbyte outioffset inioffset xor mungebytesi mod 4 transport data classification top secret comint xi drv fm nsacssm 1232 dated 24 feb 98 declon xi relir last saved 4172013 090800 pm fashioncleft_protocoldoc page 14 of 26 pmtej 3ssm 021500 pm classification top secret comint xi 2323 ufouo encryption rc6composite csi rc6composite is defined as rc6 encryption using output feedback mode ofb mode using the composite exfil key rc6 with different ml for each data packet for each data packet an independent packet ml is computed from the base ml sent in the implant header modified by one or more bytes from the data packet ip header this allows each data packet to be decrypted separately regardless of previous packet losses the ml modifier is specified as mimoffset and mimlength in bytes into the ip header csi the ml modifier defaults are mimoffset4 miml_ength4 which specify bytes 47 from the ip header ip identification field 2 bytes ip flags 3 bits ip frag ment offset 13 bits csi to compute the individual packet ml the ml modifier bytes from the ip header are xored with the base ml from the implant header as follows packetmi015 implantheadermi015 implantheader7691 packetmii ipheaderimimoffset 0miml_engthl csi the portion of the packet layer that is encrypted is passed during the session announcement in the metadata block as one of the tags listed below the shellgrey tags are classification top secret comint xi drv fm nsacssm 1232 dated 24 feb 98 declon xi relir last saved 4172013 090800 pm fashioncleft_protocoldoc page 15 of 26 pmtej 3ssm 021500 pm classification top secret ii comint ii xi table 23231 ssl rc6composite shellgrey tags name tag value packet layer packet_decrypt_rc6 deprecated never implemented to lieo 16byte key 16byte ml operation packet_rc6_mi deprecated never implemented 86 10 16byte ml operation packet_rc6_mi_modi fl er 86 16 2byte unsigned mimoffsetbyte 1 mimlengthbyte 16 ip header for all tags below apply rc6composite decrypt to specified layer starting at offset for length bytes length oxff end of packet packet_decrypt_rc6 86 13 2byte unsigned offsetbyte lengthbyte packet data packet_decrypt_rc6_i p4 86 14 2byte unsigned offsetbyte lengthbyte ip data packet_ decrypt_rc6_ip4_transport 86 15 2byte unsigned offsetbyte lengthbyte transport data 24 ufouo transmission ufouo session announcements can be transmitted in several ways these are raw ip packet tcpudpicmp sent to predetermined lp and port tcp connection steganographlc tunnel ufouo using raw ip packet single ip packet would be constructed where the sa would be contained within the ip transport protocols payload the ip and transport protocol tcpudpicmp would be constructed to route the packet to predetermined destination ip address ip protocol and for tcpudp the port number this method provides reliable transport note currently only udp sa packets have been implemented classification top secret comint xi drv fm nsacssm 1232 dated 24 feb 98 declon xi relir ic f oc last saved 4172013 090800 pm fashioncleft_protocoldoc page 16 of 26 last printed 6152009 021500 pm classification top secret comint xi ufouo using tcp connection the sa would be sent as stream data to predetermined destination ip address and tcp port number this method offers not only reliable network transport by allows acknowledgement feedback from the lp making this method reliable ufouo using steganographic tunnel the sa would hide within higherlevel network protocol this method offers both improved opsec from detection but also offers reliable transport by allowing acknowledgement feedback from the lp csi transmission of data packets would be similar to raw ip packet by its nature but only the destination ip address is predetermined all tcpudp ports and icmp packets are allowed csi selection of method and parameters would be subject to the security posture imposed by target environment 25 ufouo constraints and tinning issues ufouo the fashioncleft protocol is designed to operate over an unreliable network protocol where only communication from the sender is possible unless the session announcement could occur using reliable network protocol and even bidirectional protocol the data packets are clearly unreliable to synchronize fashioncleft communications between the sender and receiver entities under all conditions certain constraints and timing issues must be observed basically the fashioncleft sender implant has an active role for maintaining proper synchronization while the receiver lp has passive role what follows is list of conditions follow by discussion of each sending of the session announcements new or continuation of terminated session termination of session sending data packets to session announcement ports duplicate data packets simultaneous exfil of multiple sessions early termination sending of the session annoucemnets ufouo generally the session announcement sa would be send prior to data packets be sent if the sa data is sent using an unreliable network transport it may be lost in transit to overcome this the sa data should be sent more than once since data packets may arrive prior to sa data the receiver will buffer all received ip packets for fifteen 15 minutes once valid sa arrives the buffer will be scanned for possible data packets to insure at least one sa arrives more than three should be sent within the 15 minute time window unless the sa is sent using reliable protocol in addition for cases where the duration of exfiltration of data packets is short and the sa path is unreliable the sender should also make at least three 3 attempts to send the sa termination of session ufouo once the session is established the lp will terminate the session and stop looking for and forward data packets to the backend when the following two conditions are met classification top secret comint xi drv fm nsacssm 1232 dated 24 feb 98 declon xi cclj1in _ 7 rc last saved 4172013 090800 pm fashioncleft_protocoldoc page 17 of 26 pmtej 3ssm 021500 pm classification top secret comint xi 1 data packet has arrived for ten 10 minutes 2 sa has arrived for ten 10 minutes new or continuation of terminated session ufouo when an authenticated sa arrives the packet selection criteria as well as the fogynull identification fields will be used to determine if the packet is new or existing collection if new the fashioncleft receptor will begin data packet collection if it is redundant the sa is ignored ufouo if the sa that arrives is in actuality for session that has been terminated the fashionclef receptor will be tasked to start data packet collection as if it was new session the inner portion of the cdr will rejoin these disjoint captures of the same session by using the exfiljd metadatatag and fogynull identifiers provided that more than fifteen 15 minutes between termination of the last session and the start of the next session with the same exfilid from the implant ufouo to insure separate session are not inadvertently joined by the cdr implants should allow at least sixty 60 minutes between the reuse of exilid values sending data packets to session announcement ports ufouo to minimize testing every packet for session announcements being sent to the fashioncleft receptor only certain destination ports will be monitored for session announcements these ports can be arbitrarily configured to address the needs of specific deployed implants if an implant chooses or is required to by conditions imposed by the target environment it may send data packets to these ports as well packets that match data packet selection criterion are not checked for session announcements therefore implants that desire to send announcements to the same port as data packets must choose packet selection criteria carefully duplicate data packets ufouo implants that desire to send duplicate data packets are permitted and may be desirable in some cases to insure that critical portions of the session are received by the fashioincleft receptor duplicate data packets will occur as an artifact of packet sniffing by default data packets that are either duplicated by design or by coincidence generally will be removed by post processing during session reconstruction simultaneous exfil of multiple sessions ufouo implants that desire to exfiltrate multiple disjoint sessions simultaneously or even sessions backtoback must utilize the exfilid in conjunction with the packet selection criteria the exfilid is used to identify disjoint sessions while packet selection criterion is used to associate data packets to particular session implants must choose both such that both are unique per session and the above conditions are met early termination classification top secret comint xi drv fm nsacssm 1232 dated 24 feb 98 declon xi relir last saved 4172013 090800 pm fashioncleft_protocoldoc page 18 of 26 pmtej 3ssm 021500 pm classification top secret comint xi ufouo if an implant sends session announcement that has new exfilid but has packet selection criterion that is identical to an existing criterion the previous session will be terminated and all new data packets that satisfy the criterion will be associated to the new exfilid classification top secret comint xi drv fm nsacssm 1232 dated 24 feb 98 decl on xi caeuiamri d last saved 4172013 090800 pm fashioncleft_protocoldoc page 19 of 26 lasf pm 615200g 021500 pm classification top secret comint xi 3 ufouo packet selection algorithms 31 ufouo description ssi this section describes the methods used to associate metadata with non encapsulated egress packets that are transmitted independently from the data that is desired to be exfiltrated specifically it addresses allowable contents for the packetif selector and packetifdata fields of the fogynull infrastructure header infhdr the following table identifies the specific values for the packetifselector field to select which algorithm to be used to do an association this indicates whether the packetifdata field is used to convey parameters for the selected algorithm the packetifdata field can be up to 32 bytes in length table 311 packet interface algorithm interpretation value algorithm contents of data 0x00 none not used 0x01 generic pattern matching matching rules 0x02 fixed ip4 field matching matching rules ufouo all methods other than the null case contain associated packetifdata the number and format of the bytes comprising the packetifdata vary based on the value of packetifselector however to allow for cases in which data receptor may not understand particular packetifselector value the packetifdata field will always begin with 1byte field indicating the number of bytes in the packetifdata field excluding this 1byte length field so for the nonnull types specified above the corresponding packetifdata fields are as follows table 312 packetif data length 1 byte data 131 bytes ssi otherwise the contents of packetifdata should be left as random data 32 u algorithms 321 u none 0x00 ssi this represents the null case ie the case in which there is defined mapping association hence packets will be collected only the metadata is forwarded the content of packetif data is unused classification top secret comint xi fashioncleft_protocoldoc page 20 of 26 drv fm nsacssm 1232 dated 24 feb 98 declon xi last saved 4172013 090800 pm last printed 6152009 021500 pm classification top secret comint xi 322 u generic pattern matching 0x01 ssi this method implements generic static pattern matching against specified bytes within the received packets the content of packetlfdata contains finite number of matching rules these matching rules allow pattern match against specified bytes following the start of an ip header thus they can include checks against bytes in the iptcpudp headers the rules could include checks against other bytes but the header checks would probably be the norm thus this selector would allow checks against the ip identifier field as well as elements such as ip addresses tcp window size tcp urgent data size ports etc this method is fairly general and should be able to cover any case in which portions of these headers contain fixed bytes the purpose of the data field is to specify the particular byte offsets and patterns to be used for matching against received packets nonzero number of pattern blocks must thus follow the length field which specifies the number of bytes in the pattern blocks each pattern block consists of three bytes as described below for this method received packet must match the criteria specified within all of the pattern blocks using 1byte length and 3 bytesblock implies there can be at most 10 pattern blocks within the 32byte packetlfdata field in addition using 7bit offset implies that the largest offset from the start of the ip header is 127 bytes the format of this field is lbyte length pattern block lpattern block n pattern block has the following format lbyte offset offset from start of ip header or transport protocol header bit 0 lsbit indicates start position if 0 use start of ip header if 1 use the start of transport protocol header bit 17 offset value multiply desired offset by 2 to shift into bits 17 lbyte mask mask to be used with pattern lbyte pattern pattern to be matched thus to perform pattern block check verify the following equality packet i r header_offset offset mask pattern mask the above assumes that enough packet bytes are available for error checking purposes the length field should always be multiple of the pattern block size ie 3 and pattern byte bltwlsed anded with the mask byte should always yield the pattern byte as an example suppose one wants to match any packet having an ip id field of 0x1234 the ip id field is 2 bytes long occurring at offsets 4 and 5 bytes from the start of the ip header then the following data field would be used lbyte length pattern block lbyte offset lbyte mask lbyte pattern pattern block 2 classification top secret comint xi fashioncleft_protocoldoc page 21 of 26 6 1 8 240 gxff 0x12 drv fm nsacssm 1232 dated 24 feb 98 declon xi last saved 4172013 090800 pm last printed 6152009 021500 pm classification top secret com i nt xi lbyte offset 10 250 lbyte mask oxff lbyte pattern 0x34 323 u fixed ip4 field matching 0x02 ssi this method implements static pattern matching against specified subset of ip4tcpudp header fields this method is geared toward the use of the typical 5tuple of fields used by ip and tcp or udp in addition it has the capability to handle both sides of the traffic ie it allows the sourcedestination address and port fields to be toggled ssi note the twosided sourcedestination toggling described below should normally not be used normally only single sided pattern should be specified if togging is used there will be way for the shellgrey reconstruction tags to correctly reconstruct the ip or transport header since the same reconstruction tags would be applied for both directions ie ab and b would be received as ax and b x but would reconstructed using the same value for x the toggling mode can only be used if the ip and transport headers will be dropped ssi the contents of the data field are used to specify the subset of fields and associated patterns for matching against received packets the rationale for having this method is the belief that it may often be the case that collection can be done based on the standard 5tuple used for iptcpudp uniqueness for this selector the data field will always contain the following 24 bytes lbyte length number of bytes following this field 23 lbyte mask indicates fieldstoggles to be used bit 0 mask 0x01 if set match on protocol field bit 1 mask 0x02 if set match on destination ip address note there is only one destination ip address and this match is not useful when the destination ip address must be overwritten with particular forwarding ip address bit 2 mask 0x04 if set match on source ip address field use first source ip field if bit 5 of mask is unset use both source ip fields if bit 5 of mask is set bit 3 mask 0x08 if set match on destination port fields only use first destination port field if bit 6 of mask is unset use both destination port fields if bit 6 of mask is set note if set then theres an implied match of either udp or tcp on ip protocol field bit 4 mask 0x10 if set match on source port fields only use first source port field if bit 7 of mask is unset use both source port fields if bit 7 of mask is set note if set then theres an implied match of either udp or tcp on ip protocol field bit 5 mask 0x20 if set then allow source ip address to toggle between the two alternatives classification top secret comint xi drv fm nsacssm 1232 dated 24 feb 98 declon xi cclj1in _ 0 tic last saved 4172013 090800 pm fashioncleft_protocoidoc page 22 of 26 last printed 6152009 021500 pm classification top secret comint xi bit 6 mask 0x40 if set then allow destination ports to toggle between the two alternatives bit 7 mask 0x80 if set then allow source ports to toggle between the two alternatives 2byte protocol ip protocol field used if mask bit 0 is set 4byte dstlp destination ip address used if mask bit 1 is set 4byte srclpl source ip address 1 used if mask bit 2 is set 4byte srclp2 source ip address 2 used if mask bits 2 5 are set 2byte dstportl udptcp destination port 1 used if mask bit 3 is set 2byte dstport2 udptcp destination port 2 used if mask bits 3 6 are set 2byte srcportl udptcp source port 1 used if mask bit 4 is set 2byte srcport2 udptcp source port 2 used if mask bits 4 7 are set ssi while this method allows filtering on particular 5tuple or subset its also intended to handle both sides of tcpudp connection given that the destination ip address will typically be fixed to be the forwarding ip address the only fields that can toggle are the source ip address destination and source ports this method allows any or all of those fields to toggle when toggling checks are being done only the corresponding toggling fields should be used eg srcipl dstportl and srcportl would be three values of the 5tuple if all are being used and all are allowed to toggle and srclp2 dstport2 and srcport2 would be the three toggled values of the 5tuple if all are being used and all are allowed to toggle 3231 ufouo example ip4 field matching ssi as an example suppose connection for the following 5tuple is being collected tcp 12349 567810 tcp protocol ip address 1234 using port 9 and ip address 5678 using port 10 ssi in addition suppose the collection is to be forwarded to ip address abcd and all but the destination ip address of forwarded packets to remain unchanged then the data field would be as follows 1byte length 23 1byte mask oxff 2byte protocols tcp 4byte dstip ab c d 4byte srcipl 12 3 4 4byte srcip2 56 7 8 2byte dstportl 10 2byte dstport2 9 classification top secret comint xi fashioncleft_protocoldoc page 23 of 26 drv fm nsacssm 1232 dated 24 feb 98 declon xi last saved 4172013 090800 pm last printed 6152009 021500 pm classification top secret comint xi 2byte srcportl 9 2byte srcport2 1g ssi the above data field indicates full match is required on all fields of the 5tuple it would match either of the following 5tuples tcp 12349 abcd10 protocol srclplsrcportl dstlpdstportl tcp 567810 abcd9 protocol srclp2srcport2 dstlpdstport2 ssi to indicate match on just the ip addresses the following data field could be used 1 byte length 23 1 byte mask 0x26 2 byte protocols unused 4 byte dstip abcd 4 byte srcipl 1234 4 byte srcip2 5678 2 byte dstportl unused 2 byte dstport2 unused 2 byte srcportl unused 2 byte srcport2 unused ssi the above data field would match any ip packet having either of the following two ip pairs 1234 abcd 5678 abcd ssi finally suppose that forwarded packets were to use spoofed source ip address of efgh and destination port of 7777 but the source port would be allowed to toggle in that case the following could be used 1byte length 23 1byte mask 0x5f 2byte protocol tcp 4byte dstip abcd 4byte srclpl efgh 4byte srcip2 unused 2byte dstportl 7777 2byte dstport2 unused 2byte srcportl 9 2byte srcport2 1g classification top secret comint xi drv fm nsacssm 1232 dated 24 feb 98 declon xi cclj1in _ n fie last saved 4172013 090800 pm fashioncleft_protocoidoc page 24 of 26 last printed 6152009 021500 pm classification top secret com i nt xi ssi this would match either tcp efgh9 abcd7777 tcp efgh10 abcd7777 classification top secret comint xi drv fm nsacssm 1232 dated 24 feb 98 declon xi 0 oi_ last saved 4172013 090800 pm fashioncleft_protocoldoc page 25 of 26 last prjnted 6152009 021500 pm classification top secretcomintx1 comint xi appendix glossary u glossary of terms used glossary term meaning source remarks exfiltrate to extract data through targets defenses implant software or hardware subcomponent that is surreptitiously emplaced in target environment cpu router etc to pass selected information back to nsa where it is processed for analysis ip internet protocol note all abbreviations acronyms are expanded where they are first used fashioncleft protocoldoc page a1 of 1 last saved 4172013 090800 pm last printed 6152009 021500 pm