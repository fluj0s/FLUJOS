anatomy russell ryan zack anderson alessandro chiesasubway hackof for updated slides and code see httpwebmiteduzackawwwsubway what this talk is pentesting subway systemwhat this talk is not evidence in court hopefullyyoull learn how to generate storedvalue fare cards reverse engineer magstripes hack rfid cards use software radio to sniff use fpgas to brute force tap into the fare vending network social engineer w r c r t and this is very illegal so the following material is for educational use onlyattack physical securitythere is almost always free way to get in turnstile control boxes open almost everywhere computer screens visible through windows door keys left in open boxes door keys left in open boxes 4 3 7 6 6stateoftheart surveillance often unattendeddocuments left in the open what we found on ebay attack the magcardpick the hardware13995 spark fun electronics 3track loco includes source code5 homebrew reader with inserts can read 3tracks stripesnoopsourceforgenet 300 msr206 or makstripe 3track hiloco works with our gpld software ec9010402ac9d000000005b800c80150342248a 84ebd132be10280002000000002025d0000fd60 try cloning attackis value stored on the cardyou now have free subway rides for lifeif yes thenbut you want more than that ehohreverse engineering the charlie ticketreverse engineering everybody talks about it but where do you start 1 make guess about whats in the data 2 change single variable see what changes 3 repeat many times with varying data 4 compare similar and dissimilar data 5 ignore constant regions 6 builduse toolsreverse engineering isolate variables method to locate single variable group data by that variable ignore global similarities between different groups ignore differences within groups resulting locations are probably where the data is storedec901 0402ac9d 000000005b8 00c8 028 0002 000000002025d0000 fd600150342 248 a84ebd 132 be 1ec901 0402ac9d 000000005b8 00c8 const ticket ticket type ticket passvalue in cents 028 0002 000000002025d0000 fd60 of useslast trans in nickels checksum const approx0150342 248 a84ebd 132 be 1 last reader usedlast station usedtime time const const approxforging the charlie ticketec901 0402ac9d 000000005b8 00c8 const ticket ticket type ticket passvalue in cents 028 0002 000000002025d0000 fd60 of useslast trans in nickels checksum const approx0150342 248 a84ebd 132 be 1 last reader usedlast station usedtime time const const approxec901 0402ac9d 000000005b8 fe4c const ticket ticket type ticket passvalue in cents 028 0002 000000002025d0000 fc90 of useslast trans in nickels checksum const approx0150342 248 a84ebd 132 be 1 last reader usedlast station usedtime time const const approx magcard msr206bitstir reverse engineering gui charlieticket metrocard boston ma new york city nyutilitiesmagcard reverseengineering framework read write erase conversions comparisons checksums time stamps demo magcard and reverse engineering toolkit wrote python libraries for analyzing magcards integrated with the msr206 readerwriter gui helps visualize and organize data can now forge cardswhat about other subways most subway fare collection systems in us are made by two major integrators scheidt bachmann made boston t san francisco bart long island railroad seattle sound transit london silverlink etc systems cubic transportation made nyc mta washington dc wmata chicago cta shanghai metro etc systems are they hackable yesattack the rfidlearn about your rfid cardmifare classic 1356mhz rfid smartcard endtoend proprietary crypto crypto1 1k memory unique identifier on card over 500 million tags in use crypto1 cryptanalysis crypto1 reverse engineered by karsten nohl university of virginia 2007 etched and inspected silicon wafer using highpowered imagery found and reconstructed crypto portions from over 10k gates found vulnerabilities in the cipher and implementationsecurity of the mifare card mutual 3pass authentication card reader sector key or b randomchallenge answer randomchallenge answerread key verify answer verify answereach sector two keys nonlinear filter functionssecurity of the mifare card mutual 3pass authentication card reader sector key or b randomchallenge answer randomchallenge answerread key verify answer verify answernonlinear filter functionskey is 48bitssecurity of the mifare card nonlinear filter functionskey is 48bits prg is weaksecurity of the mifare card key is 48bits prg is weak biased filter functions choose your hardwareto execute these attacks we n eed to interact with the card220 openpcd openpicc open design 1356mhz rfid reader emulator free schematics wwwopenpcdorg50 mifare rfid readerwriter comes with source code hard to hack but doable 700 usrp full control over signal inputoutput works with gnu radio our plugin usrp1356mhz 1356mhz 847khzask modulation modified miller encoding ook modulationmanchester encodingcardreader communicationtune radios receiver 1 to 1356mhz receiver 2 to 1271mhzgnu radio rfid toolchaincharlie card reader fft carrier subcarrier subcarriertune radios receiver 1 to 1356mhz receiver 2 to 1271mhzgnu radio rfid toolchain subcarrier card reader bandpass filter 400khz width fir lpf w shifted center charlie card reader fft band pass filter400khz1356mhz reader card transmission 1271mhz card reader transmission time timetune radios receiver 1 to 1356mhz receiver 2 to 1271mhzgnu radio rfid toolchain bandpass filter 400khz width fir lpf w shifted center demodulate remove carrier by converting complex iq to magnitudesubcarrier card readercarrier reader card demodulate remove carrier by converting complex iq to magnitudetune radios receiver 1 to 1356mhz receiver 2 to 1271mhzgnu radio rfid toolchain bandpass filter 400khz width fir lpf w shifted center demodulate remove carrier by converting complex iq to magnitudesubcarrier card readercarrier reader card demodulate remove carrier by converting complex iq to magnitude manchester decoder convert transitions to bitsmodified miller decoder convert transitions to bits to filesniffing the turnstilechallengeresponse pairsattacks on the mifare card goal get secret key can clone card with it brute force sniff handshake and use an fpga to crack keyfilter function weaknesses reduce key space see wwwcsvirginiaedukn5f mifarecryptanalysishtm for info on reducing key spaceattacks on the mifare card goal get secret key can clone card with it brute force sniff handshake and use an fpga to crack keyfilter function weaknesses reduce key spacemanipulate prg timing random challenge depends on clock cycles since powered up thus it is not random this enables replay attacks timing allows selection of specific challenges with deterministic challenges data can be replayed keep on transmitting those add 5 commandsattacks on the mifare card goal get secret key can clone card with it brute force sniff handshake and use an fpga to crack keyfilter function weaknesses reduce key spacemanipulate prg timing random challenge depends on clock cycles since powered up thus it is not random algebraic attacks write crypto1 as system of mu ltivariate quadratic equations combined with sniffed data convert to sat and then solve it with satsolver currently being worked on by courtois nohl and oneilbrute force itwhen all else failswhy brute force with an fpga because its fast dedicated logic hardware description language defines hardware hundreds of parallelizations general purpose device finite instruction set 18 parallelizations uh oh sounds riscymicroprocessor fpgafpga brute forcing platformcode generatorkwickbreak gui crypto1 desfpgakwickbreak fpga bruteforcer executes known plaintext attack to recover key generates usesinterfaces w runs on hardware used opal kelly xem3001 wwwopalkellycommodule xorplugin input wire clk input wire 470 key input wire 470 plaintext output reg 470 encrypted output reg ready always posedge clk begin ready 1 encrypted key plaintext endendmodulewriting trivial xor modulekwickbreakgeneratorpy please enter your plugin module name as written xorplugin output filename and path xorbruteforceutilv how many cores would you like on the chip 50 if you have pipelined design ho w many clock delays for valid data 0 xorbruteforceutilv successfully writtenwriting trivial xor module cont now just create new project in xilinx ise load the files and synthesize donesubways using mifare classic boston charliecard london oyster card netherlands ovchipkaart m i n n p l i s south korea upass h n g k n g beijing madrid subet rio janeiro riocard new delhi b n g k k and moreattack the networknetwork security performed site surveys of t stations and offices wifi found performed wireless device audit found unguarded network switchesfiber switches in unlocked room connect fare vending machines to the internal networkfiber switches in unlocked room connect fare vending machines to the internal network executed the phantom meeting attacksocial engineering gained access to internal network drops and computers nobody suspected thing as we walked intooffices and conference rooms so we took it up notchfirst there was wardialing c1983 2000 2001 2002 2006 2007 2008then there was wardriving c1983 2000 2001 2002 2006 2007 2008then there was warwalking c1983 2000 2001 2002 2006 2007 2008then there was warflying c1983 2000 2001 2002 2006 2007 2008andwarboatingthen there was warrocketing c1983 2000 2001 2002 2006 2007 2008then there was warballooning c1983 2000 2001 2002 2006 2007 2008and now warcarting c1983 2000 2001 2002 2006 2007 200819dbi wifi antenna directional control box w key switch for activationtwo laptops for control and data loggingpantilt mechanism attachments include antennas or smoke grenade launcher 900 mhz antenna directional great for cordless phonesflash drive dropper for u3 hacksaws12dbi wifi antenna omnidirectional 251300 mhz antenna general coverage great for picking up the policescanner to pick up various communications lights 2m candlepower for night operations pa speaker for announcements and intimidating musicccd camera trip documentation antenna switch box to toggle between antennas and radios w arcartwe decided to take it to the mbta headquarterswe decided to take it to the mbta headquartersand then we ran into some problems with the police thats one of the warcarts smoke grenades by the wayso to avoid ending up like this we turned backcontributionscontributions 1 exploited physical security holes 2 reverse engineered the charlieticket 3 wrote code to analyze generate magcards 4 wrote toolchain for analyzing 1356mhz rfid transactions using the usrpgnuradio 5 attacked problems with the mifare classic cards 6 wrote brute forcer generator to crack keys on an fpga 7 developed software to reduce mq to sat allowing key recovery 8 wrote code to read and clone mifare cards given the key