top secretcomint20291123 ufouo tor 2006 ces summer program abstract u tor is an opensource anonymization program created by roger dingledine nick mathewson and paul syverson originally sponsored by the us naval research laboratory and now backed by the electronic frontier foundation it routes users trac through several servers in way that hides the users location tssi we have seen several targets using tor our goal was to analyze tor source code and determine any vulnerabilities in the system we set up an internal tor network to analyze tor trac in the hopes of discovering ways to passively identify it we also worked to create custom tor client which allows the user ner control contents 1 u tor overview 3 2 ufouo objectives 4 3 ufouo objectives 1 and 2 4 4 ufouo mjolnir 4 41 ufouo building circuits 5 42 ufouo sending and receiving data 6 43 ufouo mjolnir gui for windows 7 5 ssi tors x509 certi cates 8 51 ssi mjolnirs x509 certi cates 8 6 u tors hidden services 10 7 ufouo possible attacks 10 71 tssi denialofservicestyle attacks with mjolnir 11 711 tssi coil attack 11 712 tssi flower attack 12 72 ufouo trac analysis 12 721 u basic tor circuit 12 722 ssi locating known hidden services 15 73 ssi discovering unknown hidden services 16 74 ufouo maninthemiddle attack 17 1 top secretcomint20291123 topsecretcomint20291123 8ufuture areas ofstudy 17 81uf ouo expanding mjolnirs functionalit y18 82uprivoxy18 83utorremote control18 84tssi directory serverexploitation 19 9uacknowledgmen ts 19 10ureferences 19 auf ouo torglossary 21 buprogramming details 21 b1ubuilding circuits 21 b11 uchoosing aserver23 b2uconnecting thecircuit 24 b3uencryption 26 b31 utls encryption 26 b32 uonion skins 27 cuhidden services 29 c1uo ering ahidden service 29 c2uaccessing ahidden service 29 duinformation atthenodes 30 d1ufirstnode31 d2usecond node32 d3uthird node32 d4uhidden service nodes33 d41 uintroduction points33 d42 urendezv ouspoints34 euf ouo mjolnir api 35 e1uinitialization 35 e2ssi circuit building 37 e3uf ouo sending andreceiving data 39 e4ssi smartlists andcerti cate masking 42 e5tssi dosst yleattacks44 fuf ouo mjolnir forwindo ws 46 f1uinterface 46 f2ssi creating newcircuits 46 f3tssi dosst yleattacks47 f4tssi sending arbitrary packets47 2 topsecretcomint20291123topsecretcomint20291123 f5ufuture features 49 f51 uminor changesbug xes49 1utoroverview utorisanimplemen tation ofanonion routing system itscreators useaspecialjargon todescrib eitsworkings please consult appendix atorglossary forde nitions tors anonymization worksbyhavingatorclientsenditstrac through acircuit ofthree serverseachrunning torunder severallayersofencryption thisaccomplishes several things most basically thetorserversmanyofwhicharelisted onpublicly advertised directory serversarechosen toactasaseries ofproxiesthismayseemtobeexcessiv ely complex asasingle proxyservercanbeusedtohideoneslocation butasinglehop proxy isvulnerable intwowaysfirst byanalyzing thepattern ofthetrac going toandfrom theproxyserveritispossible todeduce whichclientsaremaking whichrequests second ifanattackerownstheproxyserverthenitcertainly knowswhoisasking forwhat and anonymization isruined byusing multiple hops torismuchmore resistan ttobothof these attackstracanalysis becomes extraordinarily dicult asitmustbecoordinated across severalmachines andanattackermustownallthehopsalong thecircuit inorder totrace requests backtotheoriginating client uiftorsonlyfeature wastheusemultiple proxiesitwouldnotnecessarily mean thatitcould notbeattackedsomewaysuchasknowingwhichcircuit aclientwillchooseto route trac through orsimply reading requests sentintheclearandlooking foridentifying information howevertorleverages theopenssl cryptographic libraries toencrypt the dataitsends andtochooserandom circuits inorder topreventanattackerfromgaining useful information utheseries oftorserversusedtorelayaclientstcp trac isreferred toasa circuit circuits aresetuponeserveratatimeinawaythatkeepsanysingle serverfrom knowingtheentirelayoutofthecircuit theclientconnects tothe rstserveritthen asksthe rstservertoconnect tothesecond serverfinally itsends arequest through the rstserverthatasksthesecond serverconnect tothethird servereachserveronly knowswhoconnected toitandtowhom itconnected whichisjustoneservereachway inthecircuit amore detailed explanation canbefound inappendix b1 uthephrase onion routing refers tothewaythatencryption islayeredtohide information sentdownthecircuit when setting upthecircuit theclientnegotiates keys witheachoftheserversitwillberouting through most circuits intorcontainthree serverssotheclientnegotiates three secret keysonewitheachserverwhen theclient wantstosendsome data forexample anhttp get request it rstencrypts thedata onceusing eachkeyitsends thepackettothe rstserverwhichremovesonelayerof encryption andpasses along thepackettothesecond serverthesecond serverremoves another layerofencryption andsends thepackettothethirdserverwhen thethirdserver removesalayerofencryption thenthepacketisnowintheclear andtheserverwillsend thehttp get totheappropriate destination inthiswayonlythethirdservercansee 3 topsecretcomint20291123topsecretcomint20291123 whattheclientissending andtoanyoneoutside ofthetorcloud itappearsthatthethird nodeoriginated therequest uinshort torusesacombination ofencryption andmultiple proxiestohidewho issending what through thetorcloud 2uf ouo objectives 1uf ouo become familiar withtorbysetting upaninternal tornetwork 2uf ouo read thedocumen tation andcodeofaswellasexamine thepackets sentandreceivedbytheclient 3ssi developdetailed clientspeci cations andrequiremen tsanddocumen tthem forthecomm unity 4ssi create torclientlibraries tobeleveraged byanetworkenabled application 5ssi create atorclientusing theabovetorlibraries thatallowsforonthe tweaking oftheclientsbehaviorinthetorcloud uf ouo wefeelthatweaccomplished allofthese objectivesaswellasafew other unspeci ed goals thispaperdiscusses ourprogress onallofthese objectives 3uf ouo objectives1and2 ssi wesetupourowninternal tornetworkoneightmachines intheprotocolex ploitation labthenetworkconsisted oftwodirectory servers veserversand1machine thatwascon gured toactonlyasaclientthey wereconnected toeachother through thesame hubandweusedethereal tosni packetsthattheysentbackandforth uf ouo torisalarge opensource projectandwewereabletodownload its source codeanddocumen tation fromtore org mostofouranalysis wasperformed using source codefrom torversions 01117 and01121 there werenomajordi erences betweenthetwoversions andthecorefunctionalit yofbuilding circuits andmaintaining interserv erconnections remained unchanged uf ouo ouranalysis wasthreefold wereadtheprotocolspeci cation exam inedthesource codeandobserv edtheactual behaviorofourowntorcloud thisgave usanexcellen tideaofhowtorworksallowingustoformulatehypotheses regarding tors behaviorwhichwecould thenimmediately test 4uf ouo mjolnir tssi another majorobjectivewasthespeci cation anddevelopmen tofacustom tor clientlibrary wedevelopedalibrary thatallowstheprogrammer controloverallaspects 4 topsecretcomint20291123topsecretcomint20291123 ofbuilding acircuit andsending data ourlibrary isasportable astoritself andwehave successfully compiled andtested itonbothwindo wsandlinuxwenamed thelibrary mjolnir whichisthename ofthors hammer fromnorse mythology tssi mjolnir isamodi cation oftoranditisideally indistinguishable from anoriginal torclientassuchitshould appearidenticaltotorintrac toeasethis processweusedoriginal torfunctions whenev erpossible howeveritsmain purposeis toprovidetheprogrammer withgreater controloverallaspectsoftorinthenormal tor clientalmost allserversinallcircuits chosen randomly using mjolnir theprogrammer canbuildcircuits oneserveratatime withnolimittothenumberofserversinthecircuit then theprogrammer cansendanarbitrary tcppayload across thecircuit thathebuilt andprocesstheresponsehoweverhewishes tssi allofmjolnirs most importantcallsinsetting upacircuit aswell assending data areblocking thisisbecause thetorcodeisinextricably linkedwith libeventanopensource library thatallowstheusertosetupsignals thatcanbehandled whenev ertheyareneeded whereas toruseseventsandafunction called oncepersecond toperform allitsnecessary checksandcorrections mjolnir useslibeventinternally so thateachfunction doeswhatitshould dobeforereturning controltothecalling program itwouldbeunfair toanyprogrammer torequire thatanyprogram using mjolnir should alsobeforced touselibeventatthesamelevelthattordoeswefeltthathavingblocking callswasthelesser oftwoevilsinthissituation asonlyprograms thatfollowtorsstructure could possibly ndlibeventaviable wayofcontrolling program owmjolnirs solution ofusing libeventinternally doesmaketheprogram slowerbutallowstheprogrammer to knowwhether allofhisrequests succeed orfailimmediately uponreturn tohisprogram 41uf ouo building circuits tssi themostfundamen talportion ofmjolnir isitscapabilit ytobuild arbitrary circuits ofanylength using ourlibrary aprogrammer canbuild acircuit useitforsome trac thenextend itandcontinueusing itliketormjolnir allowsmultiple circuits tobeactiveatonetime andtheusercansendtrac along anyofthem tssi inorder tobuild acircuit theclientmusthaveinformation aboutsome oftheserversinthetorcloud thisinformation iskeptonthedirectory serversand theirmirrors andtogetthisinformation theclientmustrequest itspeci cally fromthe directory mjolnir providesafunction updaterouterdescriptors whichautomates thisprocessonce mjolnir hasthedirectory itcanbuild circuits toanyoftheservers thatitknowsaboutserversthathavemiddlemanonly exitpolicies arestillallowedto beattheendofthecircuit asitisbeingbuilt howevershould thecalling program want datatotravelacross thecircuit itmustbeusing anexitnodethatwillallowtrac to exittowhere theprogram wantsittogoormjolnir willrefuse tosendthetrac in the rstplace tssi inorder tobuild acircuit theprogrammer mustbeginwithacallto mjolnirs function newarbitrary circuit bynickname whichreturns anewcir cuittstructure withthegivenserverasits rstnodemjolnir alsoprovides aset 5 topsecretcomint20291123topsecretcomint20291123 offunctions thatwillappendanother servertoagivencircuit there isalsoafunction thatwillreturn arandom circuit ofagivenlength whichisprovided bothinorder to retain someoftorsoriginal functionalit yandtoeasetheprocessofconstructing acircuit mjolnir isdesigned toprovideasmuch exibilit yaspossible providing theprogrammer withawidearrayofoptions forbuilding andextending circuits tssi inane ort toprovidearobust suite offunctions mjolnir provides errorc heckingatmanydi eren tlevelsofcircuit construction torserverswillfailwhen askedtoconnect tothemselv esbutthaterror willnotbecome apparen tuntildatais sentacross thecircuit toavoidthisproblem mjolnir willwatchwhat serversare added tothecircuit anditwillrefuse toaddaserverifitiscurren tlyattheendofthe circuit inthiscase thecircuit isnotdestro yedbutthere isatleastonesituation in whichattempting toaddacircuit willresult inthedestruction oftheentirecircuit ifthe program attempts toconnect toaserverthathasgonedownsincebeingadded thenthe circuit willbedestro yedthisisinitiated bytheendofthecircuit rather thantheclient sowehavenocontroloveritthecalling program should alwayscheckreturn values to ensure thatcircuit constructions andextensions weresuccessful 42uf ouo sending andreceiving data tssi mjolnir wouldnotbeuseful ifitcould notcomm unicate withother computers fortunately tormakesiteasyformjolnir tosendandreceivedatawithout relying on anoutside program tosenddata mjolnir musthavethree things amessage destination andacircuit across whichtosendthemessage presumably the rsttwo areapplication dependen twhile thecircuit iseasyenough tobuild using mjolnirs functions once acircuit isbuiltandamessage isready tobesenttheprogrammer needs tocallsendpayload downcircwiththecorrect argumen tsandthemessage should get tothedestination eachnewpayload creates anewapplication proxyap connection whichisonlyusedinternally normally outside applications eg awebbrowser send theirmessages across torusing apconnections instead ofcreating apconnections when itgetsarequest fromanother program mjolnir creates anapconnection when ithas something tosendacross acircuit tssi before themessage issentmjolnir setsuplibeventeventssothatitcan successfully readandwrite across thatconnection itusesthewrite eventimmediately when itsends apayload itmuststilllisten foraresponsebeforereturning controltothe calling program inorder toprovideareasonable amoun toftimetoreceivearesponse mjolnir usesatimeout scheme modeled ontcp timeouts ifmjolnir doesnot receivearesponsebeforethetimeout runsdownthenitwillshutdowntheconnections itiswaiting onandreturn tothecalling program tssi theoretically there should beawaytoshutdownconnections more ele gantlythanusing timeouts forexample consider ifmjolnir shutdownaconnection when itreceivedacellthatwaslessthanthemaxim umlength initially thisseems likea goodideabecause torserversshould minimize thenumberofpacketstheysendbysend ingmaximallength payloads whenev erpossible howeveruponinspection ofthepackets 6 topsecretcomint20291123topsecretcomint20291123 figure 1tssi thebasic guiwindo wshowingclockwise fromtopleft circuits available serversandcircuit contents serversdonotalwayssendmaximallength cellssothismetho ddoesnotworkalso as farastorisconcerned there isnodi erence betweenacellatthebeginning ofamessage andacellattheendsothere isnoeasywaytoknowthatamessage iscomplete without parsing thepayload tssi once mjolnir receivesacell itcalls auserset function payload readhandler thisisapointertoafunction thattakesastring thepay load anditslength unfortunately duetotheproblems describ edabovethere isnoway tohandle anentireresponseifitcomes inmorethanonecelleachcellishandled individ uallyhoweverbysetting thisvariable seetheapiintheappendix thecalling program candoanyoperation ontheincoming cellsthereb yparsing outanynecessary data the exibilit orded bythisarrangemen tislargely whatmakesmjolnirs comm unication capabilities souseful 43uf ouo mjolnir guiforwindo ws tssi inaddition toporting themjolnir library towindo wsinadynamic link library dll wecreated agraphical userinterface gui toimplemen tacustom tor clientforwindo ws tssi initscurren tstate thewindo wsversion ofmjolnir hasthefollowing capabilities creating newcircuits appending anodetoanalready existing circuit creating random circuits ofarbitrary length 7 topsecretcomint20291123topsecretcomint20291123 performing coil and owerattacksonservers appending coils and owerstoexisting circuits sending arbitrary packetsthrough acircuit uf ouo seeappendix ffordetailed information onthewindo wsversion of mjolnir 5ssi torsx509 certi cates ssi theonlypartofanormal torinteraction thatdoesnottakeplace under tls encryption isthetlshandshak ewhichhastobedoneintheclear wechosetofocuson thistrac toseeifthere wasanywaytoidentifytortrac sincealltrac under tls encryption looksthesame utorcreates twox509 certi cates shortly after starting upinthefunction tortlscontext newthe rstcerti cate contains ashortterm connection keyand issigned bythemachines public rsakeyitsidentitykeythesecond isaselfsigned certi cate containing theidentitykey uatypical torx509 certi cate isshownintable 1 ssi thestring tor appearsintheorganizationname ofboththesubject andissuer portions ofthex509 certi cates thismeans thatweseethisstring inthe clearduring thetlshandshak ebyalsotaking advantageoftheasn1 encodingthat surrounds thestring inthecerti cate wewereableto ndabytesequence thatappears ineverytortlshandshak ethismakescollection easyaswesimply lookforthebyte sequence intrac seetable 2forthesequences 51ssi mjolnirs x509 certi cates tssi when atorserverreceivesacerti cate itwillverifythatitspeersentita certi cate withalloftherequired elds forx509 certi cates andthatitssubjectscom monname eldexists andisalphan umeric torserverswillnotreject acerti cate witha periodinthem buttheywillgenerate alogmessage tothee ect thatsomeone whoisnot using toristrying toconnect tothemachine itdoesnotcheckthattheorganizationname foreither subjectorissuer istor anditdoesnotchecktoseethattheidentity string iseverpresen tbecause ofthismjolnir caneasily sendacerti cate withfalse orrandom information andstillconnect tothetorcloud tssi tosendafalsi ed certi cate mjolnir justneeds anarrayof eldv alue pairs where the eldisthe eldname ofthex509 certi cate egcommonname or ganizationname countryco deandthevalueisthecorresp onding valueofthe eldeg mjolnir pantheonse aslongasthe eldv aluepairisvalidmjolnir will putitintothecerti cate sothatanyonewatchingtrac willnotimmediately realize that thetrac fromamachineusing mjolnir istortrac 8 topsecretcomint20291123topsecretcomint20291123 table1utorsx509 certi cate version 30x2 thisishardco dedintotor serial numbersomenumbercurren tlywedont knowifthisisarandom numberorifthere issome signi cance wedoknowthatitiscreated withan openssl function signaturealgorithm sha1withrsaencryption issuer otor cnstring identitytor willalwaysbepresen tasthe organizationname thecommonname eldismorevariable string willbethenick name oftheserveraslisted inthepublic directories forclientswithout nicknames itwillbethestring clientnotethatitwillalwaysbefollowedbyidentity validity notbefore time thisisthetimethatthetlscerti cate wascreated by tor notafter time bydefault thisis2hours later subject otor cnstring again tor istheorganizationname this ishardco dedandwillalwaysbepresen tstring willbejustthenickname ofthe serverinthe rstcerti cate andwillcontainidentityinthesecond selfsigned certi cate subjectpublic keyinfo public keyalgorithm rsaencryption rsapublic key modulus 1024bit somenumbervaries exponent655370x10001 thisishardcodedintotor signature algorithm sha1withrsaencryption thisisfollowedby1024bits ofsignature 9 topsecretcomint20291123topsecretcomint20291123 bytesequence found inalltorx509 certi cates 30xx310c300a060355040a1303544f5231xx30xx060355 0403 bytesequence found inx509 certi cates ofclientswithdefault settings 302a310c300a060355040a1303544f52311a3018060355 04031411636c69656e74203c6964656e746974793e this corresp onds roughly tothepartofthecerti cate thatsaysorganization nametor andcommonnameclien tidentity table2ssi torbytesequences tssi iftheprogrammer doesnotprovidemjolnir withthesubjectscommon name thenitwillrandomly generate using openssls random bytegenerator alegal commonname between10and21byteslong thisensures thateveniftheprogrammer forgets togiveacerti cate totheprogram there willbenoidentifying information inthe tlshandshak 6utorshidden services utorallowsmachines too eratcpservice without revealing theiripaddress using thesame anonymization techniques asclientsconnected tothenetworksuchservices canonlybeconnected tothrough thetornetworkandareaccessed byspecialonion addresses resolvedbytordirectory serversthiso ers severalbene ts totheoperator of theservice suchaservice canbehosted frombehind rewallornatandanyattackers attempting toperform adistributeddenialofservice attackwillbestymied because they donotknowthemachines ipaddress fordetails onthehidden service protocolssee appendix c ssi curren tlythere areroughly 50publicly advertised hidden services this numberseems lowgiventorsrising popularit yitseems likelythatmorethan50hidden services exist theabilitytolocatehidden services isimportantasonlythenwillwebe abletopoliceandor exploit them unfortunately wewerenotableto ndanygoodwayto discoveranewhidden service orto ndwhere aknownhidden service ishosted formore discussion seesections 722locating knownhidden services and73discovering unkno wnhidden services 7uf ouo possible attacks tssi thisportion ofthepaperwillbedevotedtoseveralpossible attacksrelated to tortheir application ismostly speculativ easwehavenotimplemen tedanyofthem except forthemjolnirrelated attacksandwehavenotattempted anyofthem outside 10 topsecretcomint20291123topsecretcomint20291123 ofthelabthese descriptions areintended tobeusedaspossible avenuesforfuture researc handdevelopmen t 71tssi denialofservicest yleattackswithmjolnir tssi anunmodi ed torclientwillneverinclude agivenserverinacircuit morethan once thisensures thatnoserverwillhavetodomore workthananyother however onlytheclientcancheckforrepeated serverswith mjolnir wecanbuild anarbitrary circuit ofarbitrary length violating nearly allrestrictions oncircuit construction with impunit ythiscapabilit yallowsformanyinteresting dosst yleattacksaswecanforce other servertodomanytimes theworkwehavetosince tornormally sends packetsof length 586largecircuits canheavilytaxthetorcloud ingeneral andatargeted server inparticular tssi thebiggest problem withthese attacksisthattheytakeusalargeamoun t ofworktosetupforannservercircuit wemustsendatleastncellstosetupthat circuit building acircuit cantakealargeamoun toftime especially iftheserversareon di eren tcontinentsasisthecaseinthetorcloud thenumberofpacketsgenerated is ontheorder ofn2andthetimetosetupacircuit growssimilarly once thecircuit isset uptheamoun toftrac growslinearly withthenumberofserversonthecircuit tssi thepointofbuilding these circuits istogettarget serverstohandle much more trac thanourclientmachinewhile notdisturbing therestofthetorcloud once thecircuit issetupthisisnotaproblem forexample ifwesetupacircuit inwhichone serverappears50times itwillalwaysdoatleast50times more workthanourmachine oncethecircuit isestablished wecanusethisfortwodistinct typesofattack tssi first thereisthepossibilit ythatifwehadenough circuits running through atarget machinewecould cause asocketdenial ofservice eachconnection betweentwo torserversusesdistinct socketsonce twomachines areconnected toeachother they willalwaysusethesame socketsbutwithenough machines connecting toaserveritis theoretically possible tocause amachinetouseallofitsavailable sockets tssi alsotorgivesserverstheoption ofsending onlyalimited amoun toftrac through thetornetworkinagivenperioddayweekormonthbytargeting amachine withthese attackswecould cause aservertohibernate essentially taking itoutofthe torcloud untilthenextaccoun tingperiodbegins thiscould alsomakebandwidth costs prohibitiv elyhighfortargets 711 tssi coilattack tssi our rstimplemen tedtechnique forachieving either typeofattackiswhat we callthecoil attackforthisattackwechoosetwotarget serversandsetupacircuit that bounces backandforthbetweenthetwocoiling them around eachother when weset upacircuit ofnccoilsthecircuit willactually becomposedof2ncserversthisisbecause foreachcoilbothtargets areincluded once thisattackisconcen trated butrequires two targets inorder toworkthismaybedetected byanobserv antsysadmin butbydefault 11 topsecretcomint20291123topsecretcomint20291123 torslogsdonotstoreipaddresses sotheinformation wouldhavetocomefromelsewhere evengiventhenecessary ipinformation thesystem administrator willseeonlytheother target sending andreceiving largequantitiesofinformation without further investigation andsome creativ ethinking itishighly likelythatthesystem administrator willassume ourother target isactually launchingthedosattackwecanleverage theanonymity provided bytortoprotect ourselv esfromeasydetection bysimply appending thiscoil ontotheendofacircuit 712 tssi flowerattack tssi oursecond implemen tedtechnique forachieving adosattackiswhatwecallthe owerattackandittargets onlyoneserverinthisattackmjolnir builds acircuit toarandom serverthentothetarget thenanother random onethenthetarget andso onforaspeci ed numberofpetals when wesetupa owerwithnppetals thecircuit willactually becomposedof2npserversthe owerattackdistributes mostoftheload amongst themachines ofthetorcloud soatmostthetarget serverwillsuspectthatitis beingattackedbutevenifthetarget knowsaboutanattackitwillhavetoassume that someone istrying adistributed denialofservice attackwhile thesystem administrator willlikelyrecognize thathisattackersareleveraging tortorsstrong anonymitywill leavehimwithfewoptions hewillbeforced toaccept itorreduceeliminate torusage ofhismachine tssi perhaps themostserious awwiththe owerattackisthatadministrators onthepetalsmightnotice thattheirtortrac iscoming fromandgoing tothesame serveraviolation oftorsprotocolwhichclearly requires acustom clienthoweverthe petalsstillwouldnothaveenough information toknowwhere therequest originated and anyattempt todiscoverthiswouldnecessarily break theanonymityoftorinorder toget around thiswecould build apetalwithtwoserversbetweentheinstances ofthetarget serverinthiswaynoserverrealizes thatitistaking partinanattack 72uf ouo tracanalysis ssi isthere awaytoundotheanonymitythattorprovides itdoesnotappearthat torleaks anysigni can tinformation abouttheclienttoanyoneother thantheclient howeveritisstillpossible toanalyze thepattern oftrac inandoutofthetorcloud to trytodetermine whichclientsareresponsible forwhichrequests tordoesnotmakesuch anattackhere referred toasacorrelation attackeasy 721 uabasictorcircuit uthemostcommon activit yintoriscarried outacross circuits 3nodeslong aclient connects toa rstserverwhichconnects toasecond serverwhichconnects toathird serverwhichconnects tothedesired webpageorother service 12 topsecretcomint20291123topsecretcomint20291123 tssi forthisscenario wearemostinterested intracing arequest backtothe clientassuming thatweseeanexitnodeconnect tosomething wedeem interesting the worstandmost likelycaseisthatwewillnotownanyoftheserversalong theway there aretwotypesofpotentialcorrelation attacksalthough botharecomplex ssi first metho dcircuit tracing thismetho drequires dataonallofthe connections foreachserverintheattackedcircuit while curren tlyunrealistic ingeneral thisisapotentially powerfulattackasmall privatetornetworkforexample could possibly becompletely compromised bythistechnique uf ouo wealsoneedtohaveagoodideaofhowlongittakestosenddata across thenetworktoanother machine thiscomes withtheusual caveatsthatnetwork congestion distance betweenlinks andpacketsizea ect transmission time although in theory torpacketsareallthesame sizeowingtothe xed cellsizeinpractice wesee di eren tpacketsizes astwoormorecellssometimes getsentinthesamepacketdespite thisweshould haveagoodideaofthenetworklatency actual processing timedevoted tothecellsisminimal andcanbeignored ssi webeginbyfocusing onanexitnodemaking aconnection tomaterial of interest atthispointwemustkeeptrackofalloftheconnections thatnodehasup when theexitnodereceivesdata itwillsenditbackdownthecircuit thatrequested itthusdatacomes intotheexitnodeandthenthenodewillsendoutdataoverthe appropriate connection ssi unfortunately theexitnodewillalmost certainly besending dataoutover severalconnections wemustkeeptrackofallofthem letthenetworklatency bex seconds when weseedatagetsenttotheexitnodeweonlyneedtopayattentionto theoutgoing connections thatsendoutdataroughly xseconds later wemusttakeinto accoun tsome errorinourtiming toallowfordi erences inlatency owingtodi erences innetworkconditions wethenmakealistofallofthenodesinthetorcloud thatthe exitserversends datatothese areallpotentialsecond nodes ssi theaboveprocessmustberecursiv elyperformed onthelistofpotential second nodeshopefully thisnumberofnodeswillnotbeprohibitiv ebutwehaveno harddataabouthowmanynodesagivenmachineinthetorcloud issimultaneously connected andactivelysending datatoagain wewillusethetiming todetermine which connections areofinterest thisismade slightlyeasier bythefactthatnonodewillappear twiceinacircuit meaning thatwecanignore anyoutgoing connections fromourpossible second nodestoourexitserverwecanalsoignore anyconnections made tomachines outside ofthetorcloud ieclientsbecause thesecond servershould onlybetalking to other torserversnowwehaveanevenlarger listofnodestolookatandthese areour possible entryservers ssi finally welookattheoutgoing connections fromtheentryserversthatare sending outinformation roughly xseconds afterthepossible second nodesthisismade easier bythefactthatwearereally onlyinterested inconnections intothetorcloud from outside ofthetorcloud sowecanignore anyconnections made toother torserversso 13 topsecretcomint20291123topsecretcomint20291123 nowwehavealargelistofpotentialcircuits ssi fromhere wewatchformore interesting material tobesenttotheexit serverandrepeattheprocess weshould getadi eren tsetofpotentialcircuits asnot everyconnection should beactiveagain atroughly thesame timeexcept theconnections along thecircuit forwhichwearelooking there should besomeoverlapbetweenthetwo lists thisintersection isournewsmaller listofpotentialcircuits after repeating this processenough times weshould onlyhaveonecircuit oratmost ahandful tssi thisanalysis becomes easier foreachboxthatweownalong thecircuit sincewethenknowforsurewhichincoming connection matcheswhichoutgoing connection onthatboxthismeans thatourtreeofpotentialcircuits branchesonelesstime owning theexitserverisprobably mostuseful forthistypeofanalysis sinceitistheonlymachine knowntobeapartofthecircuit fromthebeginning tssi there aresome diculties howmanypotentialcircuits willresult from eachiteration without somedataontherealtorcloud regarding howmanyconnections eachserverissending dataoverforagivenspanoftime itisimpossible tosayitwould notbesurprising ifthisnumberturns outtobeveryverylarge evenwiththepruning at eachstep assuming thenumberofpotentialcircuits isnottoolargetoworkwith how manyiterations ofthisalgorithm willitbenecessary torunbeforewecantrackdownthe onetruecircuit again without some realdataaboutthetorcloud itisimpossible to sayclearly themore potentialcircuits we ndateachiteration themore iterations it willtaketonarrowthelistdowntoone uf ouo thebiggest problem withthisideaisthattorwillonlyuseacircuit forashort periodoftimebefore tearing downandbuilding anewonecurren tlythe default periodoftimeforthisis10minutesandtorchecksevery30seconds toseeifany circuits needtorndownsoatbestthere are10minutesduring whichonecanperform thisanalysis tssi second metho dblackboxthetorcloud inorder forthisattackto workweonlyneedtoseeconnections entering andexiting thetorcloud when wesee anexitservermakearequest ofaservice thatweareinterested inwekeeptrackofwhen information issentbackintothetorcloud wethenkeeptrackofeachclientconnected tothetorcloud thatreceivesdataafterw ardforanarbitrary amoun toftime probably atcptimeout thiswilllikelybeanenormous numberofclientseachclientwillhave acertain probabilit yofbeingtheonethatmade therequest forexample aclientthat receivesinformation 2seconds aftertheservice sends backsome dataismore likelyto betheonethatrequested itthanaclientthatreceivesinformation 10seconds afterthe service sends thedata eachtimeweseetheservice sendinformation backtothatsame exitserverwetrackwhichclientsreceivedataduring therighttimeframe eachiteration willgiveusalargenumberofclientsbutweareonlyinterested intheclientsthatreceive information eachtime thatisclientsintheintersection ofallthesetstheclientmaking therequests mustbeinthatintersection theclientwiththehighest totalprobabilit overalltheiterations isthemostlikelytobethetarget 14 topsecretcomint20291123topsecretcomint20291123 tssi thistechnique isessentially awidescale version ofthecircuittracing tech nique andislessprecise howeveritshould beeasier tocollect thisinformation asthere arecurren tlyonlyaround 450publicly knownexitserversanditiseasier towatchconnec tionsfrom450machines totheoutside ofthetorcloud thanitistowatchallconnections ofallmachines asthecircuittracing metho drequires thehopeisthatthelargeamoun t ofdatawecould collect forthismetho dwouldcompensate foritslessprecise nature 722 ssi locating knownhidden services ssi inthecaseofahidden service themost likelyscenario isthatweknowabout ahidden service andtowanttoknowwhere ieonwhat machine itislocated we woulduseatorclientandconnect tothehidden service inorder tosetupacircuit see appendix cforadescription ofhidden service circuits foranormal hidden service circuit circuit tracing wouldhavetostretchacross acircuit containing veserversmaking ittoo complex andwecannotusethetorblackboxapproac hthings mustbedonesomewhat di eren tly tssi ifweknowtherendezv ouspointrp theanalysis becomes more man ageable wecansetapreferred rpusing thecon guration leofevenabasic torclient thiswillworkforourpurposesbutifwedothat thenwewillbeusing anormal tor serverasarpmeaning thatitwillhaveseveralconnections through itatagiventime ifweprogram acustom clienttochooseanarbitrary rpperhaps evenmaking theclient boxtherpseesection 81thenwecanchoosearpoutside ofthetorcloud meaning thattheonlyconnections through itwillbeonesrelated tothehidden service forthis attackassume thatweknowtherpaswellastheserverthatitisconnected toforthis circuit ssi when theclientmakesarequest itwillgototherpwhichwillsendit downanother circuit tothehidden service thisgivesusachance totoseewhat node therpisconnected tocallitthe rstnodethen wecheckthetiming inthesame manner asinthebasic torcircuit toseetowhichserversitisconnected wecanignore anyconnections thatgooutside ofthetorcloud wenowhavealistofpotentialsecond nodesinasimilar fashion wecheckthetiming ofallofthese toseetowhichserversthey areconnected oneofthese isthehidden service ssi thehidden service willrespondsowewillseedatacome backupthecircuit totherpthisgivesusanother chance toworkwiththetiming totryand gure out thecircuit itwouldbeeasiest to gure outthesecond nodeduring thisstep onewould havetoseewhichmachines aretalking tothe rstnodejustbeforeittalkstoourrpand correlate thatlistwithourpossible second nodesfromwhen therequest wassentdown thecircuit theactual second nodeshould beintheintersection ofthese twolists ssi aswiththenormal torcircuit thiswilllikelygiveusmanypotentialcircuits andneedtobeiterated severaltimes beforethehidden service islocated there aretwo main advantages overthesame analysis foranormal torcircuit the rstisthatthere arefewerserversbetweentherpandthehidden service meaning thatweonlyneedto keeptrackoftwopossible branchesinthecircuit instead ofthree thesecond isthatwe 15 topsecretcomint20291123topsecretcomint20291123 canaskthehidden service toconnect totherpasmanytimes aswewantwhenev erwe wantthisallowsustoperform thecorrelation overandoveragain albeitwithdi eren t circuits eachtime themore datawehavethemore likelywearetolocatethehidden service ssi weknowthatthehidden service willneverbuild acircuit totherpthat contains thehidden service machine although itcanbeitsownrpthuswhatev er machinethehidden service isonwillneverbethemachinethatconnects totherpevery timeweaskthehidden service tobuildacircuit totherpwekeeptrackofwhichmachines areconnecting totherpeventually therewillbeasizable listofmachines thatcannot be thehidden service itisdoubtful thatwewillnarrowitallthewaydowntothemachine onwhichthehidden service islocated butitwillhelpusprune thepossible branchesfrom possible second nodes ssi thehidden service mayhavealistofnodesthatitwillneveruseinacircuit under excludeno desinthecon guration lethese willnevershowupasthemachine thatconnects totherpitwillhoweveruseaserverlisted under excludeno desasanrp alsothehidden service mayhavesetuponeormoreentryguards foritscircuits meaning thatthe rstnodefromthehidden service thesecond nodeintheaboveexample will alwaysbeoneofthose routers ifithasonlysetuponeentryguard thatmachinewill alsoneverbetheonethatconnects totherendezv ouspointthisisunlikelybecause most ofthetimeonesetsupmultiple entryguards xed rstnodee ectiv elyshortens your circuit byonehopsothisanalysis mayturnupthehidden services excluded nodesand entryguards evenifitdoesnotlocatethehidden service 73ssi discovering unkno wnhidden services ssi wedidnotdiscoveranymetho dtodetect previously unkno wnhidden services ifahidden service isbeingo ered onamachinethatisalsoatorserverthere maybe some noticeable di erence betweenitstrac andthatofatypical torserverhowevera hidden service maybeo ered onamachineoutside ofthetorcloud ssi inourtimeinthelabwefound thatrunning annmap onanodethatis ering ahidden service willturnuptheportthatthehidden service isusing todealwith incoming connections itcanthenbedirectly connected tooutside oftor tssi there areseveralissues withthiswemustalready suspectthemachine ofhousing ahidden service todecide todothenmap oralternately nmap severalservers inthehopesofturning upahidden service then themachinerunning thehidden service willlikelyhaveseveralportsopenandthere isnowaytotellwhichportiso ering hidden service justbylooking atthelistofopenports ahidden service mayevenbe ered onawellkno wnportsuchasport80wewouldhavetotrytoconnect toeachof theportsweseeopenonamachinetodetermine ifthere isahidden service beingrunwe wouldnotevenknowwhichprotocolthehidden service isrunning itmaybeanhttp serveranftpserveransmtp serveretctheonlything weknowisthattheprotocol mustrunovertcpitisnotenough toattempt toconnect oncetoeachportusing an http get request severalprotocolsmustbetried 16 topsecretcomint20291123topsecretcomint20291123 ssi also keepinmind thatthepeople running these hidden services aregener allyverycareful andallofthese requests andnmaps aredetectable byacannysystem administrator wecanhideourselv esbyusing tortoroute ourrequests evenifwedont trytoaccess thehidden service thetorwaybuttheattempt maywellbedetected this combined withtheshotinthedark nature ofthewhole enterprise limits itsusefulness 74uf ouo maninthemiddle attack tssi because torsx509 certi cates areselfsigned itmaybepossible toperform amaninthemiddle attackusing mjolnir toforge certi cates assume thatwewish tointercept trac betweentwotorserverswiththenicknames alice andbob they willsendx509 certi cates thatarestructured inaveryspeci c wayseesection 5we canusemjolnir tocreate ourowntorstylex509 certi cate withalice orbob inthecorrect location andappeartobetheother machine fromhere wecarry outa maninthemiddle attackinthenormal fashion tssi howeverthisonlyallowsustogetunder thelayeroftlsencryption ascoveredinsection b32 theclientsetsupalayerofencryption withtheserverfor example bob bypassing itanonion skin most ofthetime thisisdone using crea tecellwhichcontains halfofadiehellman handshak ethecontentsofthis crea tecellareencrypted tobobs publicly advertised rsakeythismeans thatwe wontbeabletoreadthecrea tecellandwestillwontbeabletoreadthecontents ofthecellsthatgothrough themaninthemiddle allwewillbeabletoseeis3bytesof header onthecellsthatwewouldrelaythrough tssi ifthemaninthemiddle intercepts acrea tefastcellitwillbeable toreadthexvaluethatitcontains andcreate ashared secret withtheclientine ect becoming the rstserverinthecircuit theintended rstservercanbecompletely removed fromthecircuit andthemaninthemiddle willseewhichserverissecond intheclients circuit tssi wedidnottestthisinourworksothere maybeissues withthisattack thatwedidnotforesee attheveryleast there isstilltheobstacle oftheauthoritativ directory serversthey actinafashion similar toatrusted third partythedirectory listing weakly associates speci c rsa public keyswithspeci c servernicknames ifa serveroperator registers theirtorserverwiththeauthoritativ edirectory serverthismust bedoneoutofband thenthisbecomes astrong association andcerti cates withalices name willnotbeaccepted unless theyhavealices listed public keythusitmaynot alwaysbepossible toperform thisattackhowevertheauthoritativ edirectory servers appearvulnerable seesection 84forfurther discussion 8ufuture areas ofstudy tssi there arestillmanyinteresting andimportantareas oftorfunctionalit ytoex plore aswithanysoftwareprojecttherearealwaysbugsto xandfeatures toaddthere 17 topsecretcomint20291123topsecretcomint20291123 arealsotwomajoravenuesofexploration inthearchitecture oftoritself thatwarrant further study because theymayprovidewaystodiscoverimportanttarget information 81uf ouo expanding mjolnirs functionalit tssi thetorcodeprovided asolid basis forourworkonmjolnir butevery modi cation opensuptheopportunit yforbugstoarise allofourworkwasdoneina small labwitheightmachines sothemjolnir codemustbetested onalarger network toseeifitstillbehavescorrectly orifitsresponsetimeissimply toolongtobeuseful there remain largeportions ofcodethatareonlyuseful toserversthatcansafely becut fromthemjolnir maincodeunfortunately wedidnothaveenough timetocompletely divorcetheclientandserversidesoftorscode tssi mjolnir stillhasonemajorde ciency itcannot connect tohidden services inorder tosuccessfully connect toonetheclientmustsetupacircuit toa rendezv ouspointthentoanintroduction pointthenmustrequest thatthehidden service meetitattherendezv ouspointdoing thismuchisveryimportantandwiththeright modi cations itbecomes possible tohaveaclientbeitsownrendezv ouspointassuch there willbeonlytwoserversbetweenourclientandthehidden service making atrac analysis attackeasier whichmayopenthewayforlocating theidentityandlocation of hidden services 82uprivoxy uf ouo torisuseful onlyforrerouting trac sothatoneslocation andor browsing habits arekeptsecret tordoesnotexamine thepacketsitsends foridentifying information suchasipaddresses because ofthistorispackagedwithprivoxyafreesoftware ltering proxyprivoxyspurposeistoscrub allidentifying information fromhttp requests etc anytoruserwhoisnotusing ltering proxylikeprivoxyisprobably leaking identifying information especially indnsrequests there maybesituations inwhichprivoxydoes nothidealloftheinformation thatneeds tobehidden forperfect anonymityhowever wedidnothavetimetostudy theinteraction betweentorandprivoxyanditwarrants some attention 83utorremote control tssi oneareaofinterest thatwelookedatbrie beforeturning toother moreuseful ideaswasthepossibilit yofusing torscontrolporttocontrolaclientorservertoro ers theoption tosetupacontrolportacontrolportwouldallowonetoremotely control anystandard guration option ofhistorserverasifheweredirectly editing tors guration lehoweverthisdidnoto erthe exibilit yorpowerthatweneeded to setupacustom clientsoweabandoned theideaearlyonthisdoesnotmean thatthere isnouseful application ofusing thecontrolportforexample onemaybeabletosetup acarefully selected setofentryguards orexitserversorbothsothatsuspected target 18 topsecretcomint20291123top secretcomint20291123 trac will always route through friendly servers there may be other ways of exploiting the control port including going so far as to modify the targets list of trusted directory servers this might send the target client to directory server in which all of the servers are friendly 84 tssi directory server exploitation tssi it may also be useful to study tor directory servers in more detail our work focused solely on the client but many attacks would be much easier with access to more tor servers the directory servers ultimately control which tor servers are used by clients we have found that server can put itself on directory server multiple times all it takes is the server running several tor processes each having di erent nickname open port ngerprint and log this only requires di erent guration for the di erent processes which are easy to set up that machine will handle disproportionate amount of trac since it is listed several times this increases the density of friendly servers in the cloud without increasing the number of servers we have set up unfortunately each listing has the same ip address which would be very noticeable to anyone who inspecting the directories tssi more useful attack would be to fool tor clients into believing that friendly box is actually someone else this could potentially be accomplished by getting the directory servers to list the friendly box as the other machine that may allow us to see more information than the target wants us to see for example if we know that certain target has list of preferred entry guards and exit servers and if we can list our machines as those servers then the target or second node respectively will be very likely to send trac through our machines making it easier to correlate the trac and determine what the target is requesting andor where the target is tssi there may be many other applications of this type of attack and for this reason directory server exploitation should be looked into 9 u acknowledgments ufouo we would like to thank the ces summer program for giving us the oppor tunity to work on this problem we would also like to the our mentor for his guidance and help with this problem also thanks to the ces summer program direc tors and the other students in the program their questions and ideas provided us with several ideas for areas of study 10 u references 1 dingledine roger tc tor control protocol httptore orgcvstordoc controlspectxt accessed 20060310 19 top secretcomint20291123 topsecretcomint20291123 2dingledine roger tordirectory protocolfor011x series httptore org cvstordo cdirsp ectxtaccessed 20060310 3dingledine roger torrendezv ousspeci cation httptore orgcvstor docrendsp ectxtaccessed 20060310 4rdingledine andnmathewson tormanpage httptore orgtorman ual cvshtmlen accessed 20060310 5rdingledine nmathewson andpsyverson torthesecondgeneration onion router httptore orgcvstordo cdesignpap ertordesignh tmlaccessed 20060310 6theonionroutert orfaqhttpwikinoreply orgnoreplytheonionrouter torfaqlastedited 20060310 7torlinuxbsdunix install instructions httptore orgdo c tordo cunixh tmlaccessed 20060310 8torprotocolspeci cation httptore orgcvstordo ctorsp ectxtac cessed 20060310 9tor servercon guration instructions httptore orgdo c tordo cserverhtmlaccessed 20060310 20 topsecretcomint20291123topsecretcomint20291123 auf ouo torglossary cell torsbasic building blockofcomm unication anymessage either senttoorfroma clientorserverwillcomm unicate incellseachofwhichisa xedlength curren tly 512bytes anymessage longer thanthisisbrokenupintomultiple cells circuit aseries oftorserversthattransfer dataforaclienttoadestination eachserver inthecircuit hasitsownlevelofencryption sothatnoservercanreadthemessage except thelastone directory thecollection ofinformation aboutserversthatareavailable foruseastor nodes directory serveraserverthatkeepsthedirectory information these canbeeither trusted hardco dedintotheclientorspeci ed inthecon guration leormirrored onnormal torservers entryguard aclientorservercanspecifyserversthatitwantsasits rstnodeinits circuits these areentryguards exitserverthelastserverinacircuit clientscanspecifypreferred exitservers hidden service aservice hosted anonymously using tortheipofsaidservice need notberevealed toanyoneaccessing itformore details seeappendix c serverrouterhopno deacomputer running torthatisconnected tothetorcloud servershavenicknames andshould beknownfromthedirectory torcloud thesetofserversrunning torwhen aclientorserverbuilds acircuit itis connecting tothetorcloud buprogramming details b1ubuilding circuits uthemostimportantstructure intoristhecircuit thatisthelistofmachines that aclientwillsenditstrac through information regarding thiscircuit ismaintained in thecircuit tstructure thisstructure stores information regarding theconnections and encryption usedbythemachinewhen sending information along thecircuit fortheclient italsocontainsalistoftheserversalong thepathandtheencryption information touse witheachserver uwhen auserwantstobuild acircuit most oftheworkhappensinthefunc tioncircuit establish circuit itispassed veparameters purposeneedcapacity needuptime internal andapointertoinfothese parameters containinformation usedto determine severalaspectsofthecircuit thatisultimately built inparticular infocontains 21 topsecretcomint20291123topsecretcomint20291123 information forconnecting toaspeci c exitserverifonehasalready beenchosen this onlyhappenswhen attempting toaccess oneoftorshidden services seeappendix c belowcircuit establish circuit isasmall function consisting ofonly20lines all oftherealworkhappensin4function callsthatitmakes ufirstcircuit establish circuit callscircuit inittowhichitpasses pur poseneeduptime needcapacityandinternal rightawaythisfunction callsanother function circuit newthisfunction allocates memory forthecircuit tstructure ini tializes several elds ofthestructure callscircuit addtoaddthenewcircuit tothe global circuit listandreturns backincircuit inittheparameters areusedtoini tialize more elds inthecircuit tstructure next itsetsthestate ofthecircuit to circuit stateorwaitindicating thatitiswaiting toestablish aconnection tothenext serverinthepathbefore itsends along anypacketsfinally circuit init returns pointertothenewlycreated circuit tstructure ubackincircuit establish circuit thefunction onionpickcpathexitis called andpassed thepointertothenewcircuit tfromcircuit initandtheparameter infooriginally passed tocircuit establish circuit onionpickcpathexit starts bygetting thelistofavailable routers using thefunction routergetrouterlist this router listiscreated using information obtained fromthedirectory serverstheprocess isnotcoveredinthispaperseesection 84 unext thefunctionnewrouteleniscalled todetermine thenumberofservers thatshould beinthecircuit thisnumberisbased onthepurposeofthecircuit and whether ornotinfoisnull butformosttorcircuits itwillbethree after anumber hasbeendecided onthefunctioncountacceptable routers checkshowmanyserversit thinks canroute trac ifthenumberofacceptable routers islessthantwothefunction returns failure andnocircuit isbuilt ifthenumberofavailable routers istwoormore butlessthenwhat wasdecided onthisbecomes thelength ofthecircuit uoneoftwothings canhappennext ifinfoisnotnull thentheserverwiththat information willbeusedasanexitandtheprogram movesonotherwise theprogram picksagoodexitserverthisisdoneinthefunction choosegoodexitserver which takesparameters purposedirarouter listneeduptime needcapacityandisinternal three ofthese areparameters originally senttocircuit establish circuit there are twocases based onthecircuits purposeforgeneral purposecircuits ifisinternal isset meaning thecircuit isintended tobeusedtoconnect toaserverwithin thetorcloud most likelyasarendezv ouspointforahidden service thentheexitserverischosen usingrouterchooserandomnode seechoosing ahopsection b11 otherwise choosegoodexitservergeneral choosestheexitserverthisfunction takesalistof allavailable exitserversdiscards anythatarecurren tlyunsuitable forexample those serversthatarelisted asdownandselects fromthose remaining onethatcanhandle the mostpending connections itthenreturns therouter information necessary toconnect to theselected server uafter initializing thecircuit andpickingoutanexittheother hopsinthecircuit mustbechosen todothistheprogram callsonionpopulate cpath thisfunction repeatedly callsanother function onionextendcpath untilthewhole circuit isbuilt in 22 topsecretcomint20291123topsecretcomint20291123 onionextendcpath choosegoodentryserver iscalled toselect the rstnodeinthe circuit thistakestheentirelistofavailable serversgetsridofthose unsuitable already chosen astheexitlistening onwrong portetc andfrom theremainder choosesa random nodeusingrouterchooserandomnode uforthemiddle hopchoosegoodmiddleserver iscalled essentiallythisis thesameroutine aschoosegoodentryserver except thatitalsoexcludes fromthelist ofpossible routers those thathavealready beenchosen asother hopsinthecircuit uforeachhopalong thecircuit onceagoodrouter ischosen thechoice isre turned tothecalling function therouter isthenappended ontothecircuit bycall ingonionappendhopthisfunction rstcallsonionappendtocpath whichaddsthis router tothelistofrouters inthecircuit howdoestheprogram keeptrackofthislist oneoftheelemen tsofthecircuit tstructure iscpathwhichisactually apointertoa crypt pathtstructure alloftheinformation necessary toconnect toeachrouter in cluding theipaddress andcrypto variables betweenthetwomachines canbefound inthis structure aswellasafewsimple bandwidth accoun ting elds cpathpointstothe rst router inthecircuit butitalsomaintainsnextandprevmembersinthecrypt patht structure whichunsurprisingly pointtothenextandprevious routers inthecircuit respectivelyitisimportanttonotethatnotonlyisthisadoubly linkedlistbutitisalso circular uafter allthree routers inthecircuit havebeenchosen andappended tothe circuit theprogram returns allthewaybacktocircuit establish circuit andmoves ontothenextimportantstepestablishing connections toalloftherouters b11 uchoosing aserver umostofthetimerouterchooserandomnodeiscalled tochoosewhichserverwillbe used despite itsname thechoiceisnotexactly random andthefunction ispassed several parameters tohelpwithitsdecision themostimportantargumen tswouldbethelistof preferred serversandthelistsofexcluded serversforsome reason twolistsofexcluded serversarepassed acharacter string containing servernicknames andasmartlist t structure seebelowcontaining serverinformation thelistsdonotnecessarily overlap several agsindicating userpreferences regarding servercapacit yuptime andthelikeare alsopassed oneoftheargumen tsstrictissetiftheuserwillonlyaccept achoice from theirlistofpreferred servers uthefunction begins bycreating asmartlist ofthepreferred serversfromwhich itremovesanyexcluded serversitwillthencallsmartlist choose toselect arandom elemen tofthatlist tssi smartlist choose isaverysimple function intorthesmartlist t structure isessentially aresizable arrayandseveralfunctions areprovided tomanage them seeappendix emjolnir apiformore onsmartlists smartlist choose generates arandom index andreturns theelemen tofthesmartlist withthatindex the random index isgenerated using theopensslrandbytes function care istakento avoidbiasintherandom numbersbymaking surethatthemaxim umvaluereturned by 23 topsecretcomint20291123topsecretcomint20291123 randbytes isamultiple ofthesizeofthesmartlist forexample supposethesizeof thearrayis10andrandbytes could return anyvalueupto25then when computing random index forthesmartlist thefunction wouldgenerate avaluelessthan25andtake itmod10because 25isnotamultiple of10thenumbers0123and4wouldoccur more often than5678and9 uifforsomereason nopreferred serverischosen forinstance nopreferred servers werespeci ed twothings canhappenifstrict issetthefunction returns null indicat ingfailure otherwise theprogram continuesbyattempting to ndserversthatmeetthe preferences indicated bythe ags thisisdonebycreating asmartlist containing allrun ningrouters thatmeetthepreferences whichispassed tosmartlist choose theonlyex ception isifthe parameter needcapacity isset inwhichcase routerlist slchoosebybandwidth iscalled whichmakesitsrandom choice slightly di eren tly urouterlist slchoosebybandwidth worksdi eren tlythansmartlist choose forthegivenlistofserversitaddsupallofthebandwidths atthesametime itcreates aseparate smartlist ofeachserversbandwidth forexample ifthe rstthree serverscan handle 200bytess 450bytess and1000bytess respectivelythenthesmartlist willhave entries200450and1000 then arandom numberbetween0andthetotalbandwidth isselected using thesame openssl function asinsmartlist choose itsteps through thesmartlist ofbandwidths summing thebandwidths andchoosesthe rstserverwhere thebandwidth sumisgreater thantherandom numberagain returning totheexample iftherandom numberwas412thesecond serverwouldbechosen because 200450 650and650412ifthenumberwas70the rstserverwouldbechosen weseethat higher bandwidth serversaremore likelytobechosen thanlowerbandwidth serversas onewouldexpect uifthefunction isstillunsuccessful in nding anacceptable servertheprogram triesonemore timeto ndanexthopthistimewithout setting anypreferences thisis thelastresort ifnoservercanbefound thenthefunction returns null andthecircuit fails b2uconnecting thecircuit urecall thataclientrecords alloftheserversinitscircuit using thecrypt patht structure once ithasdecided uponacomplete circuit theclientmustnowconnect the serversinthecircuit sotheycansendinformation backandforth intortheconnec tiontstructure holds theinformation needed tosetupsuchaconnection suchasthe ipaddress ofthenodeitconnects totheportitshould connect onandalotofother information aconnection isspeci ed byanidnumberconnections andcircuits are related incomplex waysasingle connection maybepartofseveraldi eren tcircuits and eachcircuit tstructure holds information onaprevious andnextconnection pconnand nconnrespectively uafter alltheserversthatwillmakeupthecircuit havebeendetermined circuit establish circuit callscircuit handlefirsthopfirst thisfunction re 24 topsecretcomint20291123topsecretcomint20291123 trievesinformation regarding the rstserverfromthecircuits cpathvariable thisinfor mation isusedtoseeifthere isalready aconnection tothatserverifsothatconnection willbeusedforthecircuits nconntheappropriate elds ofthecircuit tstructure aresettoholdinformation aboutthatconnection andcircuit sendnextonionskin iscalled tosetupthecrypto variables betweenthetworouters seeb3encryption for more abouttheinformation sentinanonion skin uifthere isnopreexisting connection tothe rstserverthefunction connection orconnect iscalled ittakesasargumen tstheaddress portandiden titydigest oftheserverbeingconnected totheidentitydigest isasha1 hashofthe serverspublic rsakeyandisoften usedtouniquely identifyaparticular router alot ofthings happeninthisfunction withtheultimate goalofreturning afullyinitialized connection first itcallsconnection newwhichallocates memory foranewconnection andinitializes various membersoftheconnection tstructure unextconnection orconnect callsconnection orinitconnfromaddress whichispassed thenewly created connection tstructure andtheaddress portand identitydigest oftheserverbeingconnected toittriestoretriev etheserversinformation based onitsidentitydigest whichiffound isusedto llinmorevariables innconnifit could not ndtheserverinformation thenthefunction will llinthenecessary information itself occasionally using more generic information thanwouldhavebeenretriev edbased ontheidentitydigest with allofthese things initialized thefunction willreturn to connection orconnect uthenextimportantstepisthatconnection connect iscalled thisattempts to create anonblo ckingsocketconnected totheipaddressp ortcombination itwaspassed most ofwhatgoesoninhereisbasiccsocketcalls ifsuccessful theconnection isadded totheglobal connection arrayandreadandwrite eventsfortheconnection aresetup using libeventtheeventsontheconnection areinitially settobenonreading andnon writing butastheprogram continuestheeventswillbechanged tohandle reads and writes ufinally connection orconnect willcallconnection orfinished connecting whichwillstart thetlshandshak ebetweenthetwoservers after thetlshand shakecompletes theclientwillsendacrea tecelltosetupencryption betweenit selfandthe rstserverallofthiswillbediscussed inthenextsection encryption soonceconnection orfinished connecting returns everything uptoandincluding circuit establish circuit returns uatthispointthecircuit isstillnotfullyconnected theclienthassetup itsconnection tothe rstserverandiswaiting foracrea ted cellinresponsetothe crea tecellitjustsentonce acrea ted cellisreceivedtheclientandthe rst serverhave nished agreeing ontheircrypto variables andcancomm unicate freely under alayerofencryption atthispointtheclientwillmakeanextend cellwhichcontains alloftheinformation necessary toconnect tothesecond serverinthecircuit aswellas crypto variable information forthelayerofencryption betweentheclientandthesecond serverandsenditencrypted tothe rstserver uthe rstserverwilldecrypt thecellandreadtheinformation forconnect 25 topsecretcomint20291123topsecretcomint20291123 ingtothesecond serverifthere isalready anexisting connection betweenthetwo serversthatconnection willbeusedforcomm unication along thiscircuit ifnotthen connection orconnect iscalled toopenaconnection betweenthetwoseeaboveoncea connection isopenthe rstserverpackagesthecrypto variable information forthesecond hopinacrea tecellandsends ittothesecond serveruponreceiving acrea ted cellfromthesecond hopthe rstserverpackagesthenecessary information intoanex tended cellwhichitsends backtotheclient uthiswhole processisrepeated onemore time astheclientsends anencrypted extend cellthrough the rstservertothesecond serverwhichwillsendacorresp onding crea tecelltothethirdserveragain anextended cellgetssentbacktotheclient afterthethirdserversends backacrea tedcellonce theclienthas nished setting up thecrypto variables betweenitselfandthethirdserveralloftheconnections inthecircuit havebeenmade anditisconsidered openanyapplications waiting tosendpackets through torarenoti ed thatthere isanewcircuit available touse b3uencryption utorpacketsaresentunder severallayersofencryption eachconnection betweentwo machines isunder tlsencryption additionally eachtorpayload isencrypted bythe clientonceforeachhopinthecircuit using asymmetric cipher uintorallinformation tosetupthesymmetric cipher betweentheclientand theserversinthecircuit issentinwhat isknownasanonion skin inabasic tor circuit three onion skinsaresentfromtheclientoneforeachserverinthecircuit each serverreads itsonion skinsetsupitscrypto variables andsends backinformation tothe clienttoallowthetwomachines toshare crypto variables inthiswaytheclientgetsthe necessary information toputitsdataunder onelayerofencryption foreachserverinthe circuit allcellsacross atypical torcircuit willbeunder three layersofencryption when itissentandeachserverwillstripo onelayersee gure b3foravisual represen tation ofthisprocessitisthese layersofencryption thatgivetoritsdesignation asanonion routing network thelastserverinthecircuit willhavethecellintheclearandbeable topassalong therequest found inside b31 utls encryption utorstls handshak eiscarried outin3main phases the function connection orfinished connecting seeaboveconnecting thecircuit calls connection tlsstarthandshake whichallocates memory foranewtortlscontext andinitializes severalofits elds including thesocketthatwillbewritten toandthe sslctxthatwillbeusedforcomm unication thesslctxisinitialized attorstartup andischanged every2hours itisthisstructure thatcontains thecerti cates thatare usedduring thetlshandshak easwellasthelistofcipher suites tobeused torscer cates arediscussed inmore detail insection 5torsx509 certi cates bydefault torsupports2cipher suites 26 topsecretcomint20291123topsecretcomint20291123 figure 2uf ouo layersofencryption onanormal get tlsedh rsawith des192cbc3 sha tlsdhe rsawith aes128cbc shathisispreferred uonce thetlscontextisproperlyinitialized thetlshandshak econtinuesin connection tlscontinue handshake whichcallstortlshandshake this calls sslconnect orsslaccept depending onwhichsideofthehandshak ethisisonas suming there arenoerrors theprogram movesontoconnection tlsfinishhandshake whichvalidates thehandshak eandextracts theidentitykeyfromthecerti cate ifevery thing checksoutthentheserverisconsidered authen ticated andfuture comm unications willtakeplace under tlsencryption b32 uonion skins uafter theclientpicksoutitscircuit andsetsupaconnection tothe rstserverinthe circuit itwillsendanonion skintothe rstserverthisisheldinthepayload ofeither acrea teoracrea tefastcellwhats thedi erence when theclientconnects tothe rstserveritdoessousing tls thismeans thatithasalready authen ticated the rstserversidentityandnegotiated akeythisallowsittosendacrea tefastcell whichdoesnotrequire anrsaoperation noradiehellman operation since most of thenecessary information hasalready beenestablished notethatacrea tefastcell canonlybesentbetweenaclientandthe rstserverinthepath because allother servers needtobeauthen ticated andtheclienthasnotlsconnection directly tothem forthis reason crea tecellsaresentforallother serversinacircuit ucrea tefastcellsaresimple thecellcontains onlyarandom xvalue created using torscryptorandfunction whichcallstheopenssl functionrandbytes theclientsends thistothe rstserverinitscircuit when aserverreceivesacre atefastcellitextracts thexvalueandcalculates arandom yvalueusingcryptorand 27 topsecretcomint20291123topsecretcomint20291123 itsends theyvaluebackinacrea ted fastcellalong withasha1 hashbased on xjywhere jdenotes concatenation xjyistheshared secret andwillbeusedtogenerate thekeysbetweenthetwomachines when theclientreceivesthecrea ted fastcellit willperform thesamehashbased onxjythatthe rstservershould haveandcompare it tothevalueinthecellifthetwovaluesagree thenthekeysforcomm unication between thetwomachines aresetupseekeysbelow uanonion skininacrea tecellismorecomplex the rst42bytesareoaep padding thenext16bytesareasymmetric keythisisdoneusing openssl calls the last128bytesofpayload arethegxvalueforadiehellman handshak ethe rst128 bytesofthiscellwhichgoesuptoabouthalfwaythrough thegxvalue areencrypted using thesecond serverspublic rsakeytherestofthecellisencrypted withaesin countermodeusing thesymmetric keyfromthe rsthalfofthecell uwhen aserverreceivesacrea tecellitextracts gxgenerates arandom gy computes theshared secret gxyandsends backacrea tedcellcontaining gyaswellas asha1 hashbased ongxyifamachineother thantheclientgetsacrea tedcelleg the rsthopreceivesacrea ted cellfromthesecond hop itputstheinformation in anextended cellandsends ittotheclientwhen theclientgetsacrea tedcellor anextended cellitcalculates gxyandchecksthattheaccompan yinghashiscorrect theclientusesgxytosetupthekeysthatwillbeusedwhen itcomm unicates withthat nodenotethatthiskeyexchange required expensiversaanddiehellman operations incontrasttothesimple random numbergeneration ofthecrea tefastexchange ukeys uwhen acrea ted orcrea ted fastcellisreceivedthefunction circuit finishhandshake iscalled itwillextract theshared secret anduseittocreate keysforcomm unication recall thatforacrea tedcelltheshared secret isgxyandfor acrea ted fastcelltheshared secret isxjydenote theshared secret ask0 u regardless ofwhichtypeofcell isreceived the function cryptoexpandkeymaterial ispassed theshared secret itdoesaseries ofhashes toget khk0j00 jhk0j01 jhk0j02 jwhere jdenotes concatenation thisshould notinclude morethan5hashes eachhashis20byteslong anyextra bytesareignored uthe rst20bytesofkformkhthehandshak edigest thisisusedtomake suretheother nodeshandshak echecksoutthenext20bytesbecome dftheforward digest andthenext20bytesbecome dbthebackwarddigest these digests areusedfor integritycheckingpurposes they seedahashthatisusedbymachines totodetermine whether ornotacellhasbeendecrypted allthewayornotdfisusedforclienttoserver streams anddbisusedforservertoclientstreams thenext16bytesofkbecome kf andthenext16bytesofkbecome kbkfandkbarethekeysusedtoencrypt and decrypt thestreams ofdatabetweenthetwomachines kfisusedforclienttoserver streams andkbisusedforservertoclientstreams allother bytesarediscarded 28 topsecretcomint20291123topsecretcomint20291123 cuhidden services c1uo ering ahidden service uinorder too erahidden service theoperator oftheservice whom wewillcall bobmust rstaddlinestotheirtorcon guration leindicating thedirectory containing information regarding thehidden service andtheportonwhichthehidden service will beadvertised after torstarts upwiththisnewcon guration leitwillautomatically generate anrsapublicpriv atekeypairandcreate aonion address fortheservice the address isoftheformxonion wherexisbased ontheservices public keyspeci cally xisthebase32 encodingofthe rst80bitsofthesha1 hashofthepublic key uatthispointtorpicksoutatleast3serversinthecloud toactasintroduction pointsbobmayusethecon guration letospecifyparticular serversthathewantstoact asintropointsbutifhedoesnottorwillsimply chooseaserversrandomly oncetheintro pointshavebeendecided uponbobdoestwothings hewillgenerate aservice descriptor whichcontains information abouthispublic keyandhowtoconnect tohisintroduction pointsthisservice descriptor canbeuploaded tothepublic directory serversbutit neednotbeifbobdoesnotwishtohavehisservice publicly knownbobwillalsocreate circuits tohisintroduction pointsonce thecircuit isconnected hewillsendalong cells whichcontainhispublic keyahashbased onkhseekeysinb3encryption and asignature based onthatdata these arecalled rela yestablish intr ocells uwhen anintended introduction pointreceivestherela yestablish intr cellitchecksthattheinformation iswellformed andcorrectly signed ifsoitsends acell backtobobacknowledging thatitwillactasanintroduction pointforhishidden service italsomakesnotethatthecircuit onwhichitreceivedtherela yestablish intr cellwillbeusedwhen dealing withrequests forbobs hidden service andassociates it withbobs public key uwhen bobreceivesacknowledgmen tfromhisintroduction pointsheconsiders theintroduction circuits openhewilladvertise hisservice descriptors tothetordirectory serversifhesodesires andheisnowready toreceiverequests toaccess thehidden service c2uaccessing ahidden service uthere areseveralwaysthataclientwhom wewillcallalice canbecome awareof bobs hidden service attheveryleast shemustreceivebobs public keysomeho wmost likelythrough someoutofband comm unication suchasaphone conversation orencrypted email using thisshecanrequest bobs service descriptor fromthetordirectory servers ifbobhaschosen toadvertise hisservice publicly otherwise alice mustknowbobs entireservice descriptor through some other means uonce alice hasthedescriptor anddecides totalktobobs hidden service she must rstsetupacircuit tosome serverinthetorcloud knownasarendezvous point rp thispointischosen randomly although alicecanaddalinetohertorcon guration lethatwillindicate preferred rps once thecircuit isestablished alice sends are 29 topsecretcomint20291123topsecretcomint20291123 layestablish rendezv ouscelltotherpwhichcontainsarandomly generated numberreferred toasarendezv ouscookierc uwhen therpreceivestherela yestablish rendezv ous cellitwill sendanacknowledgmen tbacktoalice andmakenotethatthecircuit thecellcame inon istobeusedforarendezv ousandisassociated withthatrc uafter alice receivesacknowledgmen tfromtherpshebuilds acircuit tooneof theintroduction pointslisted inbobs service descriptor once connected shewillsend arela yintr oduce1 celltotheintropointwhichcontains ahashofbobs public keyaswellasinformation intended forbobthatisencrypted tohispublic keywhen theintroduction pointseestherela yintr oduce1 cellitchecksthehashagainst the hashes ofthehidden service public keysthatitknowsand ndsthecircuit associated with thatpublic keyitthensends thecellnowencapsulated asarela yintr oduce2 cellwiththesamepayload downthatcircuit tobobafterw arditsends aliceacknowl edgmen tthathercellwassentandalice willshutdownhercircuit totheintroduction point uwhen bobreceivesarela yintr oduce2 cellhedecrypts itandpullsout thedataalice sentthisincludes information forconnecting totherpthercand alices halfofadiehellman handshak egxifbobdecides totalktoalice hewill create acircuit tothespeci ed rpbobsends therparela yrendezv ous1 cell whichcontainsthercbobs halfofthediehellman handshak egyandthekhforhis interaction withalice uwhen therpreceivesarela yrendezv ous1 cellit ndsthecircuit as sociated withthegivenrcitthensends gyandkhinarela yrendezv ous2 cell downthatcircuit toalice itmakesnoteofthefactthatthecircuit fromalice andthe circuit frombobarelinkedandzeroesoutthercsonooneelsecanattempt toconnect toalices circuit ufinally alicereceivestherela yrendezv ous2 cellandusesittocomplete thediehellman handshak eandinitialize thecrypto variables betweenherandbobnow alice andbobcantalkacross thisnewlyformed rendezv ouscircuit inalmost theexact samewayasanormal circuit neither knowswhatisontheother sideoftherpsothey dont knowwhere theother persons machineislocated thecontentoftheirmessages is under thenormal circuit encryption aswellasonemorelayerbased ontheirshared secret duinformation atthenodes ssi itispossible forustohaveafriendly computer inthetorcloud forexample we cansetupaserverandadvertise ittothetordirectory serverslikeallother users we mightcompromise another serverinthetorcloud through other means sohowmuchdo weknowaboutthetrac thatwearesending andreceiving across circuits tordoesa goodjobofhiding information aboutthecircuit fromallofthenodesinthecircuit in most cases allowingnodestoknowonlyaboutthemachines towhichtheyaredirectly connected howeversomeinformation isstillleakedsimply bybeingapartofthecircuit 30 topsecretcomint20291123topsecretcomint20291123 andthere aresomeinstances where torgivesthemachines slightlymoreinformation than isneeded thefollowingsection attempts toprovidealistofinformation knownbyeach serverhere referred toasanodealong thecircuit d1 ufirstnode uthe rstnodeinthecircuit istheonlynodethatknowsthelocation ofthemachine originating therequest itsetsupacircuit tvariable withaparticular pcircidand arranges ashared secret withtheoriginating nodeseesection b32 when theclient extends thecircuit tothesecond nodethe rstnodereceivesanextend cellwiththe address portandidentity ngerprin tofthesecond nodeitsetsupaconnection tothe second nodeandsetsncircidinitscircuit tvariable withanewcircuit idthesecond nodewillsendbackacellcontaining itshalfofadiehellman handshak ethat isgy andkhseekeys insection b32 foranexplanation ofkhafter thisthe rstnode should notreceiveanycellsthatitwillbeabletorecognize because thecellswillbe encrypted inshort the rstnodeknows thelocation oftheclientthatconnected toit crypto variables usedforcomm unication withtheclientwhichallowittoperform onelayerofencryptiondecryption oncellstofrom theclient theidofthecircuit fromwhichtheclientissending information thisispcircid inthe rstnodescircuit tstructure thelocation ofthesecond nodeinthecircuit theidofthecircuit onwhichitsends information tothesecond nodethisis ncircidinthe rstnodescircuit tstructure andwillbedi eren tfrompcircid gyinthediehellman handshak ebetweentheclientandthesecond nodeandkh ssi howeveramachinemaynotknowthatitistheentrynodeifthecommon name onthex509 certi cate passed during thetlshandshak eisclientidentity thenitisde nitely anentrynodebecause itistalking directly totheclientthisis sucien tbutnotnecessary ifthemachinereceivesacrea tefastcellthenitis theentrynodeasclientswillneversendacrea tefastcellfarther downthecircuit there isanoption inthecon guration lethatcanbesetsothatatorclientwillnever useacrea tefastcellandtorserverswillneverusethem butthisstillappearsto bethemost common waythattheentrynodeissetupotherwise acrea tecellis used ifthenodereceivesacrea tecellfollowedbyanextend cellitmaybethe entrynodetheonlyguaran teeforsuchapattern isthatitisnottheexitserverwhich willneverseeanextend cell tssi thisknowledge wouldbeuseless unless wecaninduce theclienttopick oneofourmachines asitsentrynodeinthecon guration lethere isanoption called 31 topsecretcomint20291123topsecretcomint20291123 entryno deswhichisacommaseparated listofservernicknames anyserversonthat listwillbepreferred when choosing anentrynodeiftheoption strictentryno desistrue thenonlyserversfromthatlistcanbechosen asentrynodesifthecon guration lecan bechanged tohaveaclientalwaysuseafriendly machineforanentrynodethenwecan discoverwhoisusing torifnotwhattheyarerequesting d2 usecond node uthesecond nodehastheleastinformation ofanynodeinthecircuit itdoesnotknow whoorwhere theclientisnordoesitknowwhat orwhere theclientisconnecting toit doesknow thelocation ofthemachineconnected toit crypto variables usedforcomm unication withtheclientwhichallowittoperform onelayerofencryptiondecryption oncellstofrom theclient theidofthecircuit from whichthe rstnodeissending information thisis pcircidinthesecond nodescircuit tstructure andshould beequal toncircid inthe rstnodescircuit tstructure thelocation ofthethird nodeinthecircuit theidofthecircuit onwhichitsends information tothethirdnodethisisncircid inthesecond nodescircuit tstructure andwillbedi eren tfrompcircid gyinthediehellman handshak ebetweentheclientandthethird nodeandkh ssi amachinecannot nitely knowthatitisthesecond nodeinacircuit if itreceivesacrea tecellfollowedbyanextend cellonthesame circuit thenthere isagoodchance itisthesecond nodehoweverthissamepattern ispossible forthe rst nodebecause rstnodesoften seecrea tefastcellsinstead ofcrea tecells itis more likelythatifamachineseessuchapattern itisthesecond node tssi itisnotpossible toinduce aclienttopickourmachineasasecond node thesecond nodeischosen usingrouterchooserandomnodewithnolistofpreferred nodespassed toittheonlypossible wayistoedittheclientscon guration leso thattheirlistofexcluded serversexcludes allboxesexcept friendly ones butthatseems unrealistic sincethatwouldprobably entaillisting hundreds ofservernicknames intheir guration d3 uthird node uthethirdnodeistheexitnodeforabasictorcircuit thismeans thatitseesrequest thattheclientmakesintheclear whichisuseful information thedownside isthatthe third nodehasnoideawhoorwhere theclientistheexitnodeknows 32 topsecretcomint20291123topsecretcomint20291123 thelocation ofthemachineconnected toit theidofthecircuit fromwhichthesecond nodeissending information thisis pcircidinthethirdnodescircuit tstructure andshould beequal toncircidin thesecond nodescircuit tstructure crypto variables shared withtheclientwhichallowsittoperform onelayerofen cryptiondecryption oncellstofrom theclient theexitnodecanseethedatatheclientissending suchasanhttp request or post dataforaform ssi amachinecanknowitistheexitnodeveryeasilythere areseveralfunctions onlycalled byexitnodessuchasconnection exitbeginconnthere isevenamacro connisedgethatwillreturn trueifitispassed anexitconnection oranapconnection whichonlyappearsattheclientsideofthecircuit tssi similar toentrynodesaclientcansetuppreferred exitnodesintheir torrc lethere isanoption called exitno desthatisacommaseparated listofserver nicknames andanyserversonthatlistwillbepreferred when choosing anexitnodeif theoption strictexitno desistruethenonlynodesfromthatlistcanbechosen asexit nodessothecon guration lecanbechanged tohaveaclientalwayscome toafriendly machineforanexitserver tssi there isoneother waytoin uence aclienttochooseaspeci c machine fortheexit servershaveexitpolicies whicharelistsoftypesofrequests thataserver willhandle forexample bydefault allserversreject trac senttoport25smtp in order todiscourage spammers fromusing torsnetworktohidetheiractivities onecan evensetupaserverthatwillreject allexittrac andonlyactasa rstorsecond node soifwesetupaserverwithamore permissiv eexitpolicythanmostother machines we willbechosen more often tohandle thesortoftrac thatother machines willnotallow forexample ifweweretoallowconnections toport25ourserverwouldbechosen to sendemail withhigher probabilit ythanitwouldforsending other typesoftrac we havenospeci c statistics regarding common exitpolicies andevenifweo eracertain exitpolicythatdoesntmean thatpeople willthink totrytosendsuchtrac through torstillthisoption ismore attractiv ethanaltering aclientcon guration lebecause itonlyrequires achange onamachinethatweown d4 uhidden service nodes uascoveredinappendix ctorusesspecialnodeswhen accessing hidden services d41 uintroduction points utheintroduction pointisthethirdnodeinacircuit thatstarts atthehidden service soitknowstheinformation listed underthird nodeaboveitisalsobrie thethird 33 topsecretcomint20291123topsecretcomint20291123 nodeinacircuit coming fromtheclientbutthiscircuit isshutdownassoonastheintro pointpasses along thehidden service request inaddition itknowsthersapublic key modulus forthehidden service thisismore information thanitneeds because when itreceivesarequest toaccess thehidden service allthatispassed along isasha1 hash ofthepublic keysoalltheintroduction pointreally needs isthathash bygiving the introduction pointtheentirepublic keytorisleaking more information thanitneeds toofcourse theonlything thatthepublic keyreally getsusistheabilitytoconnect tothehidden service butthatisnotinsigni can tconsider thesmall probabilit ythat ahidden service thatwedonotknowaboutwillselect afriendly machineasoneofits introduction pointsandtheusefulness isclear ssi amachineknowsthatitisanintroduction pointassoonasitreceivesan establish intr ocellwhichcontainsthepublic keyinfo tssi thehidden service canselect itsintroduction pointsinitscon guration lethrough eldcalled hiddenservic enodesbychanging that eld wecanin uence thehidden service tochooseourboxasitsintroduction pointbutifweareontheirbox already there arefarmore useful things wecandolikeobtaining thehidden services privatekeyifhiddenservic enodesisemptythenintroduction pointsarepickedusing routerchooserandomnode d42 urendezv ouspoints tssi rendezv ouspointsarethemostknowledgeable nodesinahidden service circuit when accessing ahidden service aclientmust rstsetupacircuit toarendezv ouspoint rp therpisthethirdnodeinthiscircuit soitknowsalltheinformation athirdnode knowsseeaboveinaddition tothisbasicthirdnodeinformation therendezv ouspointis alsogivenarendezv ouscookie arandom 20bytenumberwhichtherpwilluselater after thiscircuit issetuptheclientrequests access tothehidden service through the introduction pointtherpseesnoneofthis andifthehidden service decides toallow contactitwillsetupacircuit totherptherpisthethirdnodeinthiscircuit aswell thehidden service sends acelldownthiscircuit thatcontainstherendezv ouscookiegy foradiehellman handshak ebetweenthehidden service andtheclientandkhright nowtherponlylooksattherendezv ouscookiebutitwouldrequire onlyatrivial change tohaveitstoretheother values tssi attherpafteritdecrypts itslayerofencryption thecellisonlyunder onelayerofencryption based ontheshared secret betweenthehidden service andthe clientwecanalsoseegythisisafarcryfromknowingtheshared secret butthisisas closetobeingabletoseetrac betweentheclientandhidden service aswecangetright nowitiscertainly theweakestpointoftheentirehidden service system ssi anodeknowsthatitisarendezv ouspointassoonasitreceivesare layestablish rendezv ous cellwhichcontains therendezv ouscookie andit knowsthatthehidden service andclientareconnected across itassoonasitreceivesare layrendezv ous1 cellfromthehidden service andsends arela yrendezv ous2 celltotheclient 34 topsecretcomint20291123topsecretcomint20291123 ssi clientscanbeinduced tochooseaparticular machineasarendezv ouspoint bychanging the eldrendno desintheir guration leifthis eldisemptythe rpwillbechosen usingrouterchooserandomnodehidden services willconnect to whatev errendezv ouspointtheclienttellsthem toevenifthatnodeisnormally ontheir listofexcluded nodesassuming thatitdecides tocomm unicate withtheclient euf ouo mjolnir api uf ouo mjolnir attempts tomakeaccessing torfunctionalit ysimple belowisan apidescribing themostuseful functions ofmjolnir arranged bytopic e1uinitialization uinttorinitvoid description thisisthemain entrypointforthetorclientitmustbe called beforeanytorservices areused argumen tsnone return value return 0onsuccess return anegativ evalueonfailure notes thismust becalled beforeanyother torfunctions areused itcan becalled multiple times without issue tssi intinitkeysconstsmartlist tsubject constsmartlist tissuer description inaddition toimportantcrypto initialization initkeysgen erates x509 certi cates through internal functions whichtheprogram will usetocomm unicate withthetorcloud argumen ts thesubjectandissuer smartlists seethedocumen tation in thesection onsmartlists andcerti cates return value return 0onsuccess andnegativ evalues onfailure notes thisfunction mustbecalled inorder forthetorclienttohavespeci c certi cates ifnocommonname eldv aluepairispassed initwillgenerate arandom commonname 1020 characters long seethedocumen tation for subjectandissuer smartlists tssi routerstatus tsetchosendirserver constcharnickname int fascistfirewall description callthiswiththenickname ofanydirectory serverandthen whenev ermjolnir needs tofetchsomething itwillusethatdirectory argumen ts 35 topsecretcomint20291123topsecretcomint20291123 1nickname thenickname ofthechosen directory serverifitisnull ornot thenickname foranyvalidserverthedirserv erwillbechosen randomly 2fascist r ewallsetto1ifmjolnir isbehind rewallthatwillnotlet certain portsoutseetorsmanpageformore documen tation return value therouterstatus tstructure describing thechosen directory serverthereturn valueshould becheckedtoseeifitisnull indicating an error notes thenickname should beeither atrusted directory serverhardco ded intothelibrary oradirectory mirror inorder todownload fromamirror mjolnir must rstknowwhichserversaremirrors soitwillhavetomake atleastonerequest fromanauthoritativ edirectory tssi intupdaterouterdescriptors void description gettherouter descriptor datafromadirectory server argumen tsnone return value 0onsuccess negativ eonfailure notes thisfunction mustbecalled everytimetheprogram needs toupdate itslisting ofrouters thismustbedoneatleastoncebefore setting upany circuits itmaybedoneanarbitrarily large numberoftimes throughout the lifeoftheprogram buteachfetchwillgenerate asizable amoun toftrac to onedirectory server warning thisfunction willalwaystalktooneofthe5directory servershard codedintoconfigc 529adddefault trusted dirservers thisbehavior should beabletobechanged ifthechosen directory serverisadirectory mirror seedocumen tation forsetchosendirserver warning thisfunction isblocking itwillhaltprogram execution untilit either times outorreceivesaresponse seethetimeout documen tation tssi chargetrouterdesc stringvoid description return theexact string thattheserverreturns when mjolnir asksforthedirectory argumen tsnone return value anewcopyofastring containing allrouter descriptors as receivedfromthedirectory notes urouterlist t thede nition ofrouterlist tisinorhonlines930941 themostimportant eld isthesmartlist routers whichisasmartlist ofrouterinfo tstructures theonepart 36 topsecretcomint20291123topsecretcomint20291123 ofthese thatwillbeusedmostoften isprobably thenickname eld letusassume there isarouterlist namedrlist there arerlistroutersnum used routers available andtoaccess theirnicknames userlistrouterslisti nickname alsoseethedocumen tation ofsmartlist foreach tssi routerinfo t thefunctionroutergetrouterlist returns asmartlist ofrouterinfo tstructures seeaboveformore details themost important elds ofrouterinfo tarenick name andtheextend infousing thislibrary theprogrammer should neverhaveto dealdirectly withtheinternals ofextend infotandwillprobably neverseeitat allbutiftheprogrammer wanttoaddtothelibrary hewillneedtolookoverhow itisused thebestplace foraquickexample isanyoftheattackfunctions detailed incontrolmodc urouterlist trouter getrouterlistvoid description return thecurren tlistofallknownrouters argumen tsnone return value thelistofallknownrouters thislistwillnotbepopulated untilupdaterouterdescriptors hasrun notes seetherouterlist tdocumen tation tssi voidtorcleanupvoid description cleans upbeforeshutting tordown argumen tsnone return value none notes thismustnotbecalled unless nomore torconnections orservices areneeded callingtorinitaftercalling thisfunction doesnotworkyetit seems thattheproblem withthisisactually inshutting downandresetting the openssl library e2ssi circuit building ucircuit t theonly eldfromthisstructure thattheprogrammer needs toworryaboutis globalidenti er thisidenti er ishowtheprogram keepstrackofcircuits ithas built soifaprogram wantstohavemultiple circuits upatonce theprogrammer mustkeeptrackoftheirrespectiveglobal identi ers ormaintainalistofpointersto theactual structures tssi circuit tnewarbitrary circuit bynickname char beginrouternickname 37 topsecretcomint20291123topsecretcomint20291123 description begin anewcircuit thatcanbeadded toatanytimesolong asthefollowingtwoconditions aremet 1theclientisnotoneofthenodesinthecircuit 2thesame nodeisnotusedtwiceinarowitcanhoweverbeusedtwice inthesame circuit notethatthe rstofthese isnotcheckedincodebutinitscurren tstate clientusing thislibrary willneverbeaserversothiswillnotbeanissue argumen tsbeginrouternickname thenickname ofthe rsthopinthe newcircuit return value apointertothenewcircuit notes thisfunction mustbecalled beforeattempting toappendanewhop ontoacircuit warning thiscallisblocking itwillhaltprogram execution untilacircuit hasbeensuccessfully established tssi intappendrouterbynickname tocircuit byidcharnickname intcircid description thisfunction appendstherouter withthegivennickname to thegivencircuit itlooksupthecircuit byitsglobal identi er argumen ts 1nickname thenickname ofthenexthopinthecircuit 2circidtheglobal identi erofthecircuit return value 0onsuccess negativ evalues onfailure notes must getthecircuit idfrom acircuit returned by newarbitrary circuit bynickname ifmjolnir triestoconnect toan invalidrouter egiftherouter isdownthecircuit willclose warning thiscallisblocking itwillhaltprogram execution untilacircuit hasbeensuccessfully extended tssi intappendrouterbynickname tocircuit charnickname circuit t circ description appendrouter withthegivennickname tothegivencircuit argumen ts 1nickname thenickname ofthenexthopinthecircuit 2circthecircuit towhichmjolnir should appendarouter return value 0onsuccess negativ evalues onfailure 38 topsecretcomint20291123topsecretcomint20291123 notes must getthecircuit fromnewarbitrary circuit bynickname warning thiscallisblocking itwillhaltprogram execution untilacircuit hasbeensuccessfully extended tssi routerinfo tgetrandomrouterrouterinfo texclude description thisfunction getsarandom router fromtheglobal router list solongasthechosen router isnottheexcluded one argumen tsexclude givestheprogrammer theoption toexclude acertain router itismost useful toexclude themost recentlyappended router inthe circuit asthecircuit diesifittriestogotothesame router twiceinarow return value returns therouterinfo tforthechosen router thisis probably onlyuseful forextending thecurren tattacksinwhichcaseitwould beuseful tostudy those attackscarefully notes tssi intnickname isknownconstcharnickname description thisfunction checkstoseethatthenickname isavalidone argumen tsnickname astring withthenickname ofsome router return value returns 1iftherouter isvalidreturns 0otherwise the router isvalidiftheprogram hasrouterstatus tinformation abouttherouter withthatnickname notes theprogram mayknowaboutaninvalidrouter forexample the router mayhavebeentakendownsincetherouter descriptor wasfetchedhow everwhen mjolnir triestoconnect acircuit itwillfail tssi voidclosecircuitcircuit tcirc description givenanopencircuit closeitremoveitfromglobalcircuitlist anddeallo cateitsmemory circisnull onreturn argumen tscircthecircuit tobeclosed return value none howevercircisnull soitcannolonger beused notes e3uf ouo sending andreceiving data tssi intsendpayload downcircchar payload sizetpayload lenchar ipaddrintportcircuit tcircintforce description thisfunction sends acustom packetdowntherequested circuit tothespeci ed address atthespeci ed port 39 topsecretcomint20291123topsecretcomint20291123 argumen ts 1payloadthecustom payload eganhttpgetrequest 2payloadlenlength ofthepayload 3ipaddrtheipaddress oftheultimate destination inipv4form 19216811 asastring 4portthedestination port 5circthecircuit across whichtosendthispacket 6forceiftruethefunction willalwaystrytosendapayload iffalse itwill checkthattheaddress isreachable withthecurren texitandifitisnotit willnotsendapayload return value return 0onsuccess negativ evalues onfailure ifitrefuses tosendapacketbecause itwasnotforced itreturns failure notes itisuptothecalling program tocheckthatboththepayload and ipaddressp ortarevalidbeforecalling thisfunction thepayloadreadhandler mustbesetbeforethiscallismade warning thiscallwillblockprogram execution untilittimes outorreceives aresponse tssi payloadreadhandlerfunction pointer voidpayload readhandler constcharint description function pointertoauserde ned function thatgetscalled when theclientreceivesapayload inresponsetoitsrequest argumen ts 1constcharthepayload thattheclientreceivesinresponsetoitsre quest what thecalling program actually wantstoread 2intlength ofthepayload return value must return avoidsothereturn valuecanbeanything theprogrammer wants notes these functions should bede ned bytheusertosetthisvariable call setpayload readhandler handler example functions printpayload anddonothing aregivenintormc tssi timeouts mjolnir times outifitdoesnotreceivearesponseina certain amoun toftime onthetestlan wehaveitsetto1swhichismore thanenough time howeverduetotheslownature ofthetorcloud itmaybe necessary tochange thevalueoftheinitial timeout estimate ourtimeout fol lowsthetcpst yletimeout rules soonceithasstarted receiving cellsitshould adjust thetimeout onitsowntheconstan tsthatmayneedadjusting arein timeoutc inparticular lookatinitial estsecandinitial estusecfor thenumberofseconds andmicroseconds respectivelybeforeittimes outsee thediscussion inthesection onsending andreceiving data 40 topsecretcomint20291123topsecretcomint20291123 tssi introutershouldreachaddrintaddrintportrouterinfo t router description thefunction checkstherouters exitpolicyandreturns non zeroiftheaddress isreachable andzeroiftheaddress isnotreachable argumen ts 1addrtheaddress toreachasaninteger 2porttheporttouseataddr 3routertherouter tocheck return value ifaddrp ortisreachable returns 1ifnotreturns 0 notes tssi introutershouldreachaddrstringcharipaddrintport routerinfo trouter description thisfunction checkstherouters exitpolicyandreturns non zeroiftheaddress isreachable andzeroiftheaddress isnotreachable argumen ts 1ipaddrtheaddress toreachasastring inxxxxxxxxxxxx form 2porttheporttouseatipaddr 3routertherouter tocheck return value iftheipaddrp ortisreachable itreturns 1ifnotitreturns 0 notes thisfunction justconvertsthestring address toaninteger andcalls routershouldreachaddr tssi intcircuit shouldreachaddrintaddrintportcircuit tcirc description mjolnir checkstheexitpolicyofthecircuits exithopand returns nonzero iftheaddress isreachable orzeroiftheaddress isunreac hable argumen ts 1addrtheaddress toreachasaninteger 2porttheporttouseataddr 3circthecircuit wanttocheck return value iftheaddrp ortisreachable returns 1ifnotreturns 0 notes this function justgrabs thelasthopinthecircuit calls routershouldreachaddr tssi intcircuit shouldreachaddrstringcharipaddrintport circuit tcirc 41 topsecretcomint20291123topsecretcomint20291123 description mjolnir checkstheexitpolicyofthecircuits exithopand returns nonzero iftheaddress isreachable orzeroiftheaddress isunreac hable argumen ts 1ipaddrtheaddress toreachasastring inxxxxxxxxxxxx form 2porttheporttouseatipaddr 3circthecircuit tocheck return value ifipaddrp ortisreachable returns 1ifnotreturns 0 notes thisfunction justconvertsthestring address toaninteger andcalls circuit shouldreachaddr e4ssi smartlists andcerti cate masking usmartlist t tssi thesmartlist tstructure contains anarrayofvoidsthenumber ofelemen tsused anditstotal capacit yhowevertheprogrammer should never havetodealwiththeinternals directly instead heshould usesmartlist create smartlist addandsmartlist foreach weusethistode ne custom x509 cer cates itisnearly ubiquitous intherestofthetorcode usmartlist tsmartlist createvoid description allocateandreturn anemptysmartlist argumen tsnone return value apointertothenewsmartlist notes anysmartlist theprogrammer wantstousemust rstbereturned by thisfunction uvoidsmartlist addsmartlist tslvoidelement description appendsanelemen ttotheendofthelist argumen tsslisthesmartlist thatisreceiving theelemen titmusthave beenreturned bysmartlist create return value none notes technically asmartlist maycontainpointerstodi eren tkinds ofob jects though thisishighly unrecommended individual elemen tsofthesmartlist maybeaccessed through itslistegsllisti uvoidsmartlist removesmartlist tslvoidelement description removestheelemen tfromthelist 42 topsecretcomint20291123topsecretcomint20291123 argumen tsslisthesmartlist thatislosing theelemen tslmusthavebeen returned bysmartlist create return value none notes preserv estheorder ofanyelemen tsbeforeelement butelemen tsafter itmayberearranged tssi smartlist foreach smartlist typevarcode description smartlist foreach isamacro thatwillruncodeforevery elemen tinasmartlist allelemen tsofthesmartlist mustbeofthegiventype argumen ts 1smartlist thesmartlist overwhichmjolnir runsthecode 2typethetypeofdataheldbythesmartlist 3varthevariable name bywhichthemacro access theelemen tsofthe smartlist thevariable doesnotneedtobedeclared beforebeingused 4codethecodetobeexecuted ifthere ismore thanonestatemen tit should beincurly braces return value none notes remem berthatthisisamacro ifthecodeisbracketeditmustbe followedtheclosing brace witharightparenthesis andsemicolon tssi eldvaluepairt tssi thisisaverysimple structure containing twostrings eldandavalue these should beallocated andsetasanyother strings intheexample program this structure isadded toasmartlist sothatmjolnir canusecustom x509 certi cates tssi subjectandissuer smartlists smartlist t tssi torusesselfsigned x509 certi cates during itstlshandshak ebyde fault itsends onlycommonname normally theclientorserversnickname and organizationname normally thestring tor forbothsubjectandissuer with theonlydi erence beingthattheissuer common name isfollowedbythestring identity tssi atorserverwillcheckforrequired x509 elds butnotanything else except thesubjectscommonname andtheonlyrestrictions arethatthelength is greater than0anditconsists ofalphan umeric characters thecommonname can alsocontainaperiodbutthiscreates alogmessage ontheother servercurren tly mjolnir treats theperiodasanillegal character these listsallowtheprogram mertosendanyx509 certi cate hewishes instead ofalwayssending thesameones ifthere isnocommonname inthesubjectsection theclientwillgenerate arandom string ofcharacters 1020 byteslongtoactasthecommonname 43 topsecretcomint20291123topsecretcomint20291123 tssi ifthecommonname hasanillegal character mjolnir willgenerate random oneifmjolnir receivesasinput aninvalidx509 elditwillignore that eldv aluepairentirelyinthiswaymjolnir provides relativ elyrobust x509 certi cate generation tssi theprogrammer mustcreate twosmartlists of eldvaluepairtstruc tures oneeachforsubjectandissuer where the eldvariable isthename ofthe eldinthecerti cate andvalueissettotheappropriate string these twosmartlists mustthenbepassed toinitkeyssubject rstissuer second tssi seethedocumen tation forsmartlist t eldvaluepairtsmartlist add smartlist create andinitkeys e5tssi dosst yleattacks tssi thepurposeofthese attacksisnotactual dospersethese simply donot generate enough trac howevertheymaybeabletogenerate sucien ttrac toforcea nodeintohibernation whichtakestheserveroutofthetorcloud untilthenexthibernation periodbegins could beadayweekormonth tssi circuit tflower attackoneroutercharrouternick intnumpetals description setupaddos networkattackononetornodetheprogram willcreate acircuit consisting ofrandom routers alternating withthegiven router thisresults inthegivenrouter doing muchmoreworkthantherestof thenodesonthecircuit argumen ts 1routernick thenickname oftherouter toattack 2numpetalshenumberoftimes theattackedrouter willbeintheresultan t circuit therefore thecircuit willbe2numpetalslong return value apointertothecircuit tstructure ofthenewlyformed circuit notes when setting upacircuit withnhops theclientmustsendncells along thecircuit sosetting upalargecircuit canbeverytimeconsuming as wellasexpensivewithregards tobothtrac generated andcputimeused warning thiscallisblocking itwillhaltprogram execution untilacircuit hasbeensuccessfully established forevenamoderately longcircuit thiscan takeasubstan tialamoun toftime tssi circuit tappend flowertocircuit charrouternick1 intnumpetals circuit tcirc description similar toappendcoiltocircuit thisfunction appendsa owertotheendofthegivencircuit using thismjolnir isanonymized by thestructure ofthetorcloud 44 topsecretcomint20291123topsecretcomint20291123 argumen ts 1routernick1 therouter inthemiddle ofthe ower 2numpetalsthenumberoftimes themiddle router appearsinthe ower sothe owerwillbe2numpetals long 3circtheoriginal circuit toappendthenew owerto return value thecircuit withthe oweradded notes seethe owerattackdocumen tation tssi circuit tcoilattacktworouterschar routernick1 charrouternick2 intnumcoils description similar tothe owerattackexcept thatthisfunction generates acircuit thatbounces backandforthbetweentwonodesinthetorcloud instead oftargeting onlyonerouter argumen ts 1routernick1 nickname ofthe rstattackedrouter 2routernick2 nickname ofthesecond attackedrouter ifmjolnir sends payload downthiscircuit thesecond router willbethe nalone 3numcoilsthenumberoftimes eachrouter willappearinthecircuit so thecircuit isactually 2numcoils long return value apointertothenewlyformed circuit notes seethenotes underflowerattackonerouter thesame applies here warning thiscallisblocking itwillhaltprogram execution untilacircuit hasbeensuccessfully established tssi circuit tappend coiltocircuit charrouternick1 charrouternick2 intnumcoilscircuit tcirc description similar tothecoilattackbutputsthecoilattheendofa givencircuit using thismjolnir isanonymized bythestructure ofthetor cloud argumen ts 1routernick1 the rstrouter inthecoil 2routernick2 thesecond router inthecoil 3numcoilsthenumberoftimes eachrouter appearsinthecoil the resulting circuit willbeaslongascircplus2numcoils 4circthecircuit towhichmjolnir appendsthecoil return value thenewlyformed circuit 45 topsecretcomint20291123topsecretcomint20291123 notes seethedocumen tation forthecoilattack warning thiscallisblocking itwillhaltprogram execution untilacircuit hasbeensuccessfully extended fuf ouo mjolnir forwindo ws f1uinterface tssi theguiprovides theuserwithalistofallthecircuits created bytheclient thelistdispla ysrelevantinformation abouteachcircuit including itslength state and purposeadditionally eachcircuit hasanlighticonnexttoitsname thelightisredif thecircuit isclosed cannot beused thelightisgreen ifthecircuit isopenandready forusebeneath thecircuit listalistoftheserversinacircuit isdispla yedforthelast circuit clickedsimilar tothecircuits theserverseachhavealightnexttotheirnames to indicate whether thecircuit isopenuptothatserverthedispla ysforthecircuit listand thenodelistaresettoupdateonatimer curren tlysettothree seconds ontheright theguiprovides alistofserversthatareavailable foruseinacircuit therouter list doesnotupdateonthetimer toupdatetherouter listtheusermustclicktheload routers button f2ssi creating newcircuits tssi theguiprovides afewdi eren twaystocreate newcircuits themostgeneral waytocreate anewcircuit istoclickthenew circuit button thiswillcreate nullcircuit withausersp eci ed name andpurposeseethetordocumen tation formore information oncircuit purposetheusercanthenproceedtobuildacircuit byappending serversindividually totheendofthecircuit alternativ elytheusercancreate arandom circuit ofarbitrary length byclickingthenew random circuit button theuserthen speci aname andlength nandmjolnir willchoosenrandom serversfromthe available router listandcreate anewcircuit curren tlyallrandom circuits aremade with general purposemodifying theprogram sothattheusercanspecifythepurposeofa random circuit onlyrequires aminor change atthelibrary levelhoweveritislikelythat creating circuits ofcertain purposeswillcause theprogram tocrash seebelowcircuits canalsobecreated using thecoilor owerattacksseesection 71dosst yleattacks tssi toappendaservertoacircuit theusermust rstselect thedesired circuit byclickingonitsname inthecircuit listthiscauses thechosen circuit tobecome curren t whichmeans itisthecircuit whose nodelistiscurren tlydispla yedthen theuserright clicksonthename ofthedesired serverintherouter listandselects appendtocurren t circuit anygeneral purposecircuit thatisopencanhaveaserverappended toit tssi itshould benoted thatcircuits created withcertain purposescannot have serversappended tothem andtrying todosowillcrash theprogram curren tlyonly general introducing andestablish rend circuits areabletohaveserversappended 46 topsecretcomint20291123topsecretcomint20291123 figure 3tssi appending aservertoapreexisting circuit tothem once aserverisappended toanestablish rend circuit itspurposebecomes rend ready aonehop circuit toarendezv ouspointandattempting toappendany moreserverswillcause acrash thiswillneedtobecleaned upasfunctionalit yforcreating rendezv ouscircuits andaccessing hidden services isadded f3tssi dosst yleattacks tssi theguiprovides aninterface forperforming thecoiland owerdosattacks fromthemjolnir library inthecoilattacktheuserchoosestwoserverstoattackand thenumberofcoilsinthecircuit eachserverappearsonceinthecircuit foreachcoilso thelength ofthecircuit willbetwicethenumberofcoils forthe owerattacktheuser choosesaservertoattackandthenumberofpetals where thenumberofpetalsisthe numberoftimes theselected serverwillappearinthecircuit tssi forbothattackstheuserhastheoption tocreate thecoilor owerasa newcircuit ortoappendittoanexisting circuit howeverappending coilsor owersis moreexpensivethancreating them asnewcircuits andthere isasigni can tperformance hitforappending largecoilsand owerstocircuits f4tssi sending arbitrary packets tssi tosendapacketthrough acircuit theuser rstclicksthesend packetbutton then theuserselects acircuit tosendthemessage through andanipaddress andport numbertosendthemessage totheuserhastheoption ofentering thepayload ofthe packetineither hexorasciiuponclickingsend thepacketisencrypted withthe appropriate layersofencryption andsentthrough thecircuit theexitserverwillthen sendthedecrypted packettotheselected ipaddress anddestination port 47 topsecretcomint20291123topsecretcomint20291123 figure 4tssi thecoilattackdialog figure 5tssi sending acustom tcppacketusing themjolnir gui 48 topsecretcomint20291123topsecretcomint20291123 f5ufuture features customizing thecerti cates thisfeature iscurren tlyavailable inthemjolnir library butneeds aninterface inthegui functionalit yforcreating rendezv ouscircuits andaccessing hidden services asit becomes available inthelibrary f51 uminor changesbug xes addapurpose eldtothenew random circuit dialog boxanddealwithissues thatarisefromattempting tocreate circuits ofcertain purposes address thecrashes caused byappending serverstocircuits ofcertain purposeseither byrefusing toallowsuchanaction or xing itatthelibrary level 49 topsecretcomint20291123